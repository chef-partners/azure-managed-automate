{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "chefAMAConfigStore"
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "run": "I3IgIk5ld3RvbnNvZnQuSnNvbiIKI3IgIk1pY3Jvc29mdC5XaW5kb3dzQXp1cmUuU3RvcmFnZSIKCiNsb2FkICJjb25zdGFudHMuY3N4IgoKdXNpbmcgU3lzdGVtLk5ldDsKdXNpbmcgU3lzdGVtLlRleHQ7CnVzaW5nIE5ld3RvbnNvZnQuSnNvbjsKdXNpbmcgTWljcm9zb2Z0LldpbmRvd3NBenVyZS5TdG9yYWdlLlRhYmxlOwoKcHVibGljIHN0YXRpYyBhc3luYyBUYXNrPEh0dHBSZXNwb25zZU1lc3NhZ2U+IFJ1bihIdHRwUmVxdWVzdE1lc3NhZ2UgcmVxLCBJQ29sbGVjdG9yPENvbmZpZ0tWPiBvdXRTZXR0aW5nVGFibGUsIENsb3VkVGFibGUgc2V0dGluZ1RhYmxlLCBUcmFjZVdyaXRlciBsb2cpCnsKCiAgICAvLyBJZiB0aGUgbWV0aG9kIGlzIGEgUE9TVCB0aGVuIHN0b3JlIGluZm9ybWF0aW9uIGluIHRoZSB0YWJsZSBzdG9yZQogICAgLy8gb3RoZXJ3aXNlIGlmIGl0IGlzIEdFVCwgcmV0dXJuIHRoZSB2YWx1ZSBmb3IgdGhlIG5hbWVkIGtleQogICAgaWYgKHJlcS5NZXRob2QgPT0gSHR0cE1ldGhvZC5Qb3N0KSB7CiAgICAgICAgCiAgICAgICAgLy8gZ2V0IHRoZSBwYXlsb2FkIGRhdGEgd2hpY2ggc2hvdWxkIGJlIEpTT04gc28gaXQgbmVlZHMgdG8gYmUgZGVjb2RlZAogICAgICAgIGR5bmFtaWMgYm9keSA9IGF3YWl0IHJlcS5Db250ZW50LlJlYWRBc1N0cmluZ0FzeW5jKCk7CiAgICAgICAgdmFyIGRhdGEgPSBKc29uQ29udmVydC5EZXNlcmlhbGl6ZU9iamVjdDxEaWN0aW9uYXJ5PHN0cmluZywgc3RyaW5nPj4oYm9keSBhcyBzdHJpbmcpOwoKICAgICAgICAvLyBJdGVyYXRlIGFyb3VuZCBhbGwgdGhlIGRhdGEgdGhhdCB3YXMgc2VudCB0byB0aGUgZnVuY3Rpb24gYW5kIGFkZCB0byB0aGUgdGFibGUKICAgICAgICBEaWN0aW9uYXJ5PHN0cmluZywgc3RyaW5nPi5LZXlDb2xsZWN0aW9uIGtleXMgPSBkYXRhLktleXM7CiAgICAgICAgZm9yZWFjaCAoIHN0cmluZyBrZXkgaW4ga2V5cyApIHsKICAgICAgICAgICAgb3V0U2V0dGluZ1RhYmxlLkFkZCgKICAgICAgICAgICAgICAgIG5ldyBDb25maWdLVigpIHsKICAgICAgICAgICAgICAgICAgICBQYXJ0aXRpb25LZXkgPSBQYXJ0aXRpb25LZXksCiAgICAgICAgICAgICAgICAgICAgUm93S2V5ID0ga2V5LAogICAgICAgICAgICAgICAgICAgIFZhbHVlID0gZGF0YVtrZXldCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgCiAgICAgICAgcmV0dXJuIHJlcS5DcmVhdGVSZXNwb25zZShIdHRwU3RhdHVzQ29kZS5PSyk7CgogICAgfSBlbHNlIGlmIChyZXEuTWV0aG9kID09IEh0dHBNZXRob2QuR2V0KSB7CiAgICAgICAgCiAgICAgICAgc3RyaW5nIGtleSA9IHJlcS5HZXRRdWVyeU5hbWVWYWx1ZVBhaXJzKCkKICAgICAgICAgICAgICAgICAgICAgICAgLkZpcnN0T3JEZWZhdWx0KHEgPT4gc3RyaW5nLkNvbXBhcmUocS5LZXksICJrZXkiLCB0cnVlKSA9PSAwKQogICAgICAgICAgICAgICAgICAgICAgICAuVmFsdWU7CgogICAgICAgIC8vIHJldHJpZXZlIHRoZSBjaG9zZW4gdmFsdWUgZnJvbSB0aGUgdGFibGUKICAgICAgICBUYWJsZU9wZXJhdGlvbiBvcGVyYXRpb24gPSBUYWJsZU9wZXJhdGlvbi5SZXRyaWV2ZTxDb25maWdLVj4oUGFydGl0aW9uS2V5LCBrZXkpOwogICAgICAgIFRhYmxlUmVzdWx0IHJlc3VsdCA9IHNldHRpbmdUYWJsZS5FeGVjdXRlKG9wZXJhdGlvbik7CgogICAgICAgIC8vIGlmIGEgcmVzdWx0IGhhcyBiZWVuIGZvdW5kIGdldCB0aGUgZGF0YQogICAgICAgIGlmIChyZXN1bHQuUmVzdWx0ICE9IG51bGwpIHsKICAgICAgICAgICAgQ29uZmlnS1Ygc2V0dGluZyA9IChDb25maWdLVilyZXN1bHQuUmVzdWx0OwoKICAgICAgICAgICAgLy8gY3JlYXRlIGEgZGljdGlvbmFyeSB0byBob2xkIHRoZSByZXR1cm4gZGF0YQogICAgICAgICAgICBEaWN0aW9uYXJ5PHN0cmluZywgc3RyaW5nPiByZXNwb25zZURhdGEgPSBuZXcgRGljdGlvbmFyeTxzdHJpbmcsIHN0cmluZz4oKTsKICAgICAgICAgICAgcmVzcG9uc2VEYXRhLkFkZChrZXksIHNldHRpbmcuVmFsdWUpOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyBIdHRwUmVzcG9uc2VNZXNzYWdlKEh0dHBTdGF0dXNDb2RlLk9LKSB7CiAgICAgICAgICAgICAgICBDb250ZW50ID0gbmV3IFN0cmluZ0NvbnRlbnQoSnNvbkNvbnZlcnQuU2VyaWFsaXplT2JqZWN0KHJlc3BvbnNlRGF0YSksIEVuY29kaW5nLlVURjgsICJhcHBsaWNhdGlvbi9qc29uIikKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcmVxLkNyZWF0ZVJlc3BvbnNlKEh0dHBTdGF0dXNDb2RlLkJhZFJlcXVlc3QsIHN0cmluZy5Gb3JtYXQoIlRoZSBzcGVjaWZpZWQga2V5IGNhbm5vdCBiZSBmb3VuZDogezB9Iiwga2V5KSk7CiAgICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlcS5DcmVhdGVSZXNwb25zZShIdHRwU3RhdHVzQ29kZS5PSywgIk5vdCBTdXBwb3J0ZWQiKTsKICAgIH0KCn0KCnB1YmxpYyBjbGFzcyBDb25maWdLViA6IFRhYmxlRW50aXR5IHsKICAgIHB1YmxpYyBzdHJpbmcgVmFsdWUgeyBnZXQ7IHNldDsgfQp9Cg==",
            "constants": "c3RhdGljIHN0cmluZyBQYXJ0aXRpb25LZXkgPSAiQ2hlZkFNQSI7"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "authLevel": "function",
                            "name": "req",
                            "type": "httpTrigger",
                            "direction": "in",
                            "methods": [
                                "get",
                                "post"
                            ]
                        },
                        {
                            "name": "$return",
                            "type": "http",
                            "direction": "out"
                        },
                        {
                            "type": "table",
                            "name": "outSettingTable",
                            "tableName": "settings",
                            "connection": "AzureWebJobsDashboard",
                            "direction": "out"
                        },
                        {
                            "type": "table",
                            "name": "settingTable",
                            "tableName": "settings",
                            "take": 50,
                            "connection": "AzureWebJobsDashboard",
                            "direction": "in"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "run.csx": "[base64ToString(variables('code').run)]",
                    "constants.csx": "[base64ToString(variables('code').constants)]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "[parameters('functionName')]"
        },
        "apiKey": {
            "type": "string",
            "value": "[listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key]"
        }
    }
}