{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "NodeCount"
        },
        "logAnalyticsWorkspaceID": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID to use when adding data to Log Analytics"
            }
        },
        "logAnalyticsSharedKey": {
            "type": "securestring",
            "metadata": {
                "description": "Primary key to use for authentication to Log Analytics"
            }
        },
        "logAnalyticsEnabled": {
            "type": "bool"
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "run_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNyICJNaWNyb3NvZnQuV2luZG93c0F6dXJlLlN0b3JhZ2UiDQojbG9hZCAid29ya3NwYWNlLmNzeCINCiNsb2FkICJjb25zdGFudHMuY3N4Ig0KDQp1c2luZyBTeXN0ZW07DQp1c2luZyBTeXN0ZW0uTmV0Ow0KdXNpbmcgU3lzdGVtLk5ldC5IdHRwOw0KdXNpbmcgU3lzdGVtLk5ldC5IdHRwLkhlYWRlcnM7DQp1c2luZyBTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5Ow0KdXNpbmcgU3lzdGVtLlRleHQ7DQp1c2luZyBTeXN0ZW0uVGhyZWFkaW5nLlRhc2tzOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KdXNpbmcgTWljcm9zb2Z0LldpbmRvd3NBenVyZS5TdG9yYWdlLlRhYmxlOw0KIA0KLy8gQ2xhc3MgZm9yIHdoYXQgc2hvdWxkIGJlIHNlbnQgdG8gTG9nIEFuYWx5dGljcw0KcHVibGljIGNsYXNzIE5vZGVDb3VudA0Kew0KICAgIHB1YmxpYyBzdHJpbmcgU2VydmVyQWRkcmVzcyB7IGdldDsgc2V0OyB9DQogICAgcHVibGljIGludCBUb3RhbCB7IGdldDsgc2V0OyB9DQogICAgcHVibGljIGludCBTdWNjZXNzIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgaW50IEZhaWx1cmUgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBpbnQgTWlzc2luZyB7IGdldDsgc2V0OyB9DQp9DQogDQpwdWJsaWMgc3RhdGljIHZvaWQgUnVuKFRpbWVySW5mbyBteVRpbWVyLCBDbG91ZFRhYmxlIHNldHRpbmdUYWJsZSwgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIC8vIExvZ05hbWUgaXMgbmFtZSBvZiB0aGUgZXZlbnQgdHlwZSB0aGF0IGlzIGJlaW5nIHN1Ym1pdHRlZCB0byBMb2cgQW5hbHl0aWNzDQogICAgc3RyaW5nIExvZ05hbWUgPSAiQ2hlZkF1dG9tYXRlQU1BSW5mcmFOb2RlQ291bnQiOw0KDQogICAgLy8gR2V0IHRoZSBhdXRvbWF0ZSB0b2tlbiBmcm9tIHRoZSBjb25maWcgc3RvcmUgdGFibGUNCiAgICAvLyBhbmQgdGhlIGF1dG9tYXRlIEZRRE4NCiAgICBUYWJsZU9wZXJhdGlvbiB0b2tlbl9vcGVyYXRpb24gPSBUYWJsZU9wZXJhdGlvbi5SZXRyaWV2ZTxDb25maWdLVj4oUGFydGl0aW9uS2V5LCBBdXRvbWF0ZVRva2VuS2V5TmFtZSk7DQogICAgVGFibGVSZXN1bHQgdG9rZW5fcmVzdWx0ID0gc2V0dGluZ1RhYmxlLkV4ZWN1dGUodG9rZW5fb3BlcmF0aW9uKTsNCg0KICAgIFRhYmxlT3BlcmF0aW9uIGZxZG5fb3BlcmF0aW9uID0gVGFibGVPcGVyYXRpb24uUmV0cmlldmU8Q29uZmlnS1Y+KFBhcnRpdGlvbktleSwgQXV0b21hdGVGUUROS2V5TmFtZSk7DQogICAgVGFibGVSZXN1bHQgZnFkbl9yZXN1bHQgPSBzZXR0aW5nVGFibGUuRXhlY3V0ZShmcWRuX29wZXJhdGlvbik7DQoNCiAgICAvLyBpZiB0aGVyZSBpcyBhIHJlc3VsdCBnZXQgdGhlIGtleSB2YWx1ZSwgb3RoZXJ3aXNlIGxvZyBlcnJvcg0KICAgIGlmICh0b2tlbl9yZXN1bHQuUmVzdWx0ICE9IG51bGwgJiYgZnFkbl9yZXN1bHQuUmVzdWx0ICE9IG51bGwpIHsNCg0KICAgICAgICAvLyBnZXQgdGhlIHRva2VuIHZhbHVlDQogICAgICAgIENvbmZpZ0tWIHRva2VuX3NldHRpbmcgPSAoQ29uZmlnS1YpdG9rZW5fcmVzdWx0LlJlc3VsdDsNCiAgICAgICAgQ29uZmlnS1YgZnFkbl9zZXR0aW5nID0gKENvbmZpZ0tWKWZxZG5fcmVzdWx0LlJlc3VsdDsNCiAgICAgICAgc3RyaW5nIGF1dG9tYXRlX3Rva2VuID0gdG9rZW5fc2V0dGluZy5WYWx1ZTsNCiAgICAgICAgc3RyaW5nIGF1dG9tYXRlX2ZxZG4gPSBmcWRuX3NldHRpbmcuVmFsdWU7DQoNCiAgICAgICAgLy8gQ3JlYXRlcyB0aGUgSlNPTiBvYmplY3QsIHdpdGgga2V5L3ZhbHVlIHBhaXJzDQogICAgICAgIE5vZGVDb3VudCBqc29uT2JqID0gbmV3IE5vZGVDb3VudCgpOw0KICAgICAgICBqc29uT2JqID0gR2V0RGF0YShhdXRvbWF0ZV9mcWRuLCBhdXRvbWF0ZV90b2tlbiwgbG9nKTsNCiAgICAgICAganNvbk9iai5TZXJ2ZXJBZGRyZXNzID0gYXV0b21hdGVfZnFkbjsNCiAgICAgICAgLy8gQ29udmVydCBvYmplY3QgdG8ganNvbg0KICAgICAgICB2YXIganNvbiA9IEpzb25Db252ZXJ0LlNlcmlhbGl6ZU9iamVjdChqc29uT2JqKTsNCiAgICANCiAgICAgICAgbG9nLkluZm8oImpzb24gZmlsZSBzZW50IHRvIExvZyBBbmFseXRpY3M6ICIgKyBqc29uKTsNCiAgICAgICAgDQogICAgICAgIC8vIENyZWF0ZSBhIGhhc2ggZm9yIHRoZSBBUEkgc2lnbmF0dXJlDQogICAgICAgIHZhciBkYXRlc3RyaW5nID0gRGF0ZVRpbWUuVXRjTm93LlRvU3RyaW5nKCJyIik7DQogICAgICAgIHN0cmluZyBzdHJpbmdUb0hhc2ggPSAiUE9TVFxuIiArIGpzb24uTGVuZ3RoICsgIlxuYXBwbGljYXRpb24vanNvblxuIiArICJ4LW1zLWRhdGU6IiArIGRhdGVzdHJpbmcgKyAiXG4vYXBpL2xvZ3MiOw0KICAgICAgICBzdHJpbmcgaGFzaGVkU3RyaW5nID0gQnVpbGRTaWduYXR1cmUoc3RyaW5nVG9IYXNoLCBzaGFyZWRLZXkpOw0KICAgICAgICBzdHJpbmcgc2lnbmF0dXJlID0gIlNoYXJlZEtleSAiICsgY3VzdG9tZXJJZCArICI6IiArIGhhc2hlZFN0cmluZzsNCiAgICANCiAgICAgICAgUG9zdERhdGEoc2lnbmF0dXJlLCBkYXRlc3RyaW5nLCBqc29uLCBjdXN0b21lcklkLCBMb2dOYW1lLCBsb2cpOw0KICAgIH0gZWxzZSB7DQogICAgICAgIGxvZy5JbmZvKFN0cmluZy5Gb3JtYXQoIlVuYWJsZSB0byBmaW5kIHNlbGVjdGVkIHRva2VuIGluIHRhYmxlOiB7MH0iLCBBdXRvbWF0ZVRva2VuS2V5TmFtZSkpOw0KICAgIH0NCn0NCiANCi8vIEJ1aWxkIHRoZSBBUEkgc2lnbmF0dXJlDQpwdWJsaWMgc3RhdGljIHN0cmluZyBCdWlsZFNpZ25hdHVyZShzdHJpbmcgbWVzc2FnZSwgc3RyaW5nIHNlY3JldCkNCnsNCiAgICB2YXIgZW5jb2RpbmcgPSBuZXcgU3lzdGVtLlRleHQuQVNDSUlFbmNvZGluZygpOw0KICAgIGJ5dGVbXSBrZXlCeXRlID0gQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKHNlY3JldCk7DQogICAgYnl0ZVtdIG1lc3NhZ2VCeXRlcyA9IGVuY29kaW5nLkdldEJ5dGVzKG1lc3NhZ2UpOw0KICAgIHVzaW5nICh2YXIgaG1hY3NoYTI1NiA9IG5ldyBITUFDU0hBMjU2KGtleUJ5dGUpKQ0KICAgIHsNCiAgICAgICAgYnl0ZVtdIGhhc2ggPSBobWFjc2hhMjU2LkNvbXB1dGVIYXNoKG1lc3NhZ2VCeXRlcyk7DQogICAgICAgIHJldHVybiBDb252ZXJ0LlRvQmFzZTY0U3RyaW5nKGhhc2gpOw0KICAgIH0NCn0NCiANCi8vIFNlbmQgYSByZXF1ZXN0IHRvIHRoZSBQT1NUIEFQSSBlbmRwb2ludA0KcHVibGljIHN0YXRpYyB2b2lkIFBvc3REYXRhKHN0cmluZyBzaWduYXR1cmUsIHN0cmluZyBkYXRlLCBzdHJpbmcganNvbiwgc3RyaW5nIGN1c3RvbWVySWQsIHN0cmluZyBMb2dOYW1lLCBUcmFjZVdyaXRlciBsb2cpDQp7DQogICAgLy8gWW91IGNhbiB1c2UgYW4gb3B0aW9uYWwgZmllbGQgdG8gc3BlY2lmeSB0aGUgdGltZXN0YW1wIGZyb20gdGhlIGRhdGEuIElmIHRoZSB0aW1lIGZpZWxkIGlzIG5vdCBzcGVjaWZpZWQsIExvZyBBbmFseXRpY3MgYXNzdW1lcyB0aGUgdGltZSBpcyB0aGUgbWVzc2FnZSBpbmdlc3Rpb24gdGltZQ0KICAgIHN0cmluZyBUaW1lU3RhbXBGaWVsZCA9ICIiOw0KICAgIHRyeQ0KICAgIHsNCiAgICAgICAgc3RyaW5nIHVybCA9ICJodHRwczovLyIgKyBjdXN0b21lcklkICsgIi5vZHMub3BpbnNpZ2h0cy5henVyZS5jb20vYXBpL2xvZ3M/YXBpLXZlcnNpb249MjAxNi0wNC0wMSI7DQogDQogICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50IGNsaWVudCA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCgpOw0KICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiQWNjZXB0IiwgImFwcGxpY2F0aW9uL2pzb24iKTsNCiAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkxvZy1UeXBlIiwgTG9nTmFtZSk7DQogICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJBdXRob3JpemF0aW9uIiwgc2lnbmF0dXJlKTsNCiAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIngtbXMtZGF0ZSIsIGRhdGUpOw0KICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgidGltZS1nZW5lcmF0ZWQtZmllbGQiLCBUaW1lU3RhbXBGaWVsZCk7DQogDQogICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCBodHRwQ29udGVudCA9IG5ldyBTdHJpbmdDb250ZW50KGpzb24sIEVuY29kaW5nLlVURjgpOw0KICAgICAgICBodHRwQ29udGVudC5IZWFkZXJzLkNvbnRlbnRUeXBlID0gbmV3IE1lZGlhVHlwZUhlYWRlclZhbHVlKCJhcHBsaWNhdGlvbi9qc29uIik7DQogICAgICAgIFRhc2s8U3lzdGVtLk5ldC5IdHRwLkh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LlBvc3RBc3luYyhuZXcgVXJpKHVybCksIGh0dHBDb250ZW50KTsNCiANCiAgICAgICAgU3lzdGVtLk5ldC5IdHRwLkh0dHBDb250ZW50IHJlc3BvbnNlQ29udGVudCA9IHJlc3BvbnNlLlJlc3VsdC5Db250ZW50Ow0KICAgICAgICBzdHJpbmcgcmVzdWx0ID0gcmVzcG9uc2VDb250ZW50LlJlYWRBc1N0cmluZ0FzeW5jKCkuUmVzdWx0Ow0KICAgICAgICBsb2cuSW5mbygiUmV0dXJuIFJlc3VsdDogIiArIHJlc3VsdCk7DQogICAgfQ0KICAgIGNhdGNoIChFeGNlcHRpb24gZXhjZXApDQogICAgew0KICAgICAgICBsb2cuSW5mbygiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgfQ0KfQ0KDQovLyBTZW5kIGEgcmVxdWVzdCB0byB0aGUgUE9TVCBBUEkgZW5kcG9pbnQNCnB1YmxpYyBzdGF0aWMgTm9kZUNvdW50IEdldERhdGEoc3RyaW5nIGF1dG9tYXRlX2ZxZG4sIHN0cmluZyB0b2tlbiwgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIA0KICAgIE5vZGVDb3VudCBub2RlQ291bnQgPSBudWxsOw0KICAgIHRyeQ0KICAgIHsNCiAgICAgICAgU2VydmljZVBvaW50TWFuYWdlci5TZXJ2ZXJDZXJ0aWZpY2F0ZVZhbGlkYXRpb25DYWxsYmFjayArPSAoc2VuZGVyLCBjZXJ0LCBjaGFpbiwgc3NsUG9saWN5RXJyb3JzKSA9PiB0cnVlOw0KICAgICAgICBzdHJpbmcgdXJsID0gU3RyaW5nLkZvcm1hdCgiaHR0cHM6Ly97MH0vYXBpL3YwL2NmZ21nbXQvc3RhdHMvbm9kZV9jb3VudHMiLCBhdXRvbWF0ZV9mcWRuKTsNCiAgICAgICAgU3lzdGVtLk5ldC5IdHRwLkh0dHBDbGllbnQgY2xpZW50ID0gbmV3IFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50KCk7DQogICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ4LWRhdGEtY29sbGVjdG9yLXRva2VuIiwgdG9rZW4pOw0KDQogICAgICAgICBUYXNrPEh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LkdldEFzeW5jKG5ldyBVcmkodXJsKSk7DQoNCiAgICAgICAgaWYgKHJlc3BvbnNlLlJlc3VsdC5Jc1N1Y2Nlc3NTdGF0dXNDb2RlKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIG5vZGVDb3VudCA9IHJlc3BvbnNlLlJlc3VsdC5Db250ZW50LlJlYWRBc0FzeW5jPE5vZGVDb3VudD4oKS5SZXN1bHQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgbG9nLkluZm8oIlJldHVybiBSZXN1bHQ6ICIgKyByZXNwb25zZS5SZXN1bHQuQ29udGVudCk7DQogICAgfQ0KICAgIGNhdGNoIChFeGNlcHRpb24gZXhjZXApDQogICAgew0KICAgICAgICBsb2cuSW5mbygiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgfSANCiAgICByZXR1cm4gbm9kZUNvdW50Ow0KfQ0KDQpwdWJsaWMgY2xhc3MgQ29uZmlnS1YgOiBUYWJsZUVudGl0eSB7DQogICAgcHVibGljIHN0cmluZyBWYWx1ZSB7IGdldDsgc2V0OyB9DQp9",
            "constants_csx": "c3RhdGljIHN0cmluZyBQYXJ0aXRpb25LZXkgPSAiQ2hlZkFNQSI7DQpzdGF0aWMgc3RyaW5nIEF1dG9tYXRlVG9rZW5LZXlOYW1lID0gImF1dG9tYXRlX3Rva2VuIjsNCnN0YXRpYyBzdHJpbmcgQXV0b21hdGVGUUROS2V5TmFtZSA9ICJhdXRvbWF0ZV9mcWRuIjs="
        },
        "logAnalytics": {
            "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
            "shared_key": "[parameters('logAnalyticsSharedKey')]",
            "enabled": "[parameters('logAnalyticsEnabled')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "condition": "[variables('logAnalytics').enabled]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "name": "myTimer",
                            "type": "timerTrigger",
                            "direction": "in",
                            "schedule": "0 */5 * * * *"
                        },
                        {
                            "type": "table",
                            "name": "settingTable",
                            "tableName": "settings",
                            "take": 50,
                            "connection": "AzureWebJobsDashboard",
                            "direction": "in"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "run.csx": "[base64ToString(variables('code').run_csx)]",
                    "constants.csx": "[base64ToString(variables('code').constants_csx)]",
                    "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string sharedKey = \"', variables('logAnalytics').shared_key, '\";')]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "if(variables('logAnalytics').enabled, [parameters('functionName'), '')]"
        },        
        "apiKey": {
            "type": "string",
            "value": "[if(variables('logAnalytics').enabled, listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key, '')]"
        }
    }
}