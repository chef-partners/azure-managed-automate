{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "AutomateLogListener"
        },
        "logAnalyticsWorkspaceID": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID to use when adding data to Log Analytics"
            }
        },
        "logAnalyticsSharedKey": {
            "type": "securestring",
            "metadata": {
                "description": "Primary key to use for authentication to Log Analytics"
            }
        },
        "logAnalyticsEnabled": {
            "type": "bool"
        },
        "customerName": {
            "type": "string",
            "defaultValue": ""
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]",
            "customer": "[parameters('customerName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "AutomateLog_csx": "dXNpbmcgU3lzdGVtLk5ldDsNCg0KcHVibGljIGNsYXNzIEF1dG9tYXRlTG9nIHsNCglwdWJsaWMgc3RyaW5nIF9fQ1VSU09SIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9fUkVBTFRJTUVfVElNRVNUQU1QIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9fTU9OT1RPTklDX1RJTUVTVEFNUCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfQk9PVF9JRCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfVFJBTlNQT1JUIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIFBSSU9SSVRZIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIFNZU0xPR19GQUNJTElUWSB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBTWVNMT0dfSURFTlRJRklFUiB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfUElEIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9VSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX0dJRCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfQ09NTSB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfRVhFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9DTURMSU5FIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9DQVBfRUZGRUNUSVZFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0NHUk9VUCB7IGdldDsgc2V0OyB9DQoJcHVibGljIHN0cmluZyBfU1lTVEVNRF9VTklUIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX1NMSUNFIHsgZ2V0OyBzZXQ7IH0NCglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0lOVk9DQVRJT05fSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX01BQ0hJTkVfSUQgeyBnZXQ7IHNldDsgfQ0KCXB1YmxpYyBzdHJpbmcgX0hPU1ROQU1FIHsgZ2V0OyBzZXQ7IH0NCiAgICBwcml2YXRlIHN0cmluZyBfTUVTU0FHRV9zOw0KICAgIHB1YmxpYyBzdHJpbmcgTUVTU0FHRV9zIHsgZ2V0ew0KICAgICAgICByZXR1cm4gX01FU1NBR0VfczsgDQogICAgICAgIH0NCiAgICB9DQogICAgcHJpdmF0ZSBieXRlW10gX01FU1NBR0VfYjsNCglwdWJsaWMgYnl0ZVtdIE1FU1NBR0UgeyBzZXR7DQogICAgICAgIF9NRVNTQUdFX2IgPSB2YWx1ZTsNCiAgICAgICAgX01FU1NBR0VfcyA9IFN5c3RlbS5UZXh0LkVuY29kaW5nLlVURjguR2V0U3RyaW5nKHZhbHVlKTsNCiAgICAgICAgfQ0KICAgIH0gIA0KfQ==",
            "run_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNsb2FkICJBdXRvbWF0ZUxvZy5jc3giDQojbG9hZCAiQXV0b21hdGVNZXNzYWdlLmNzeCINCiNsb2FkICJBdXRvbWF0ZUxvZ1BhcnNlci5jc3giDQojbG9hZCAiTG9nQW5hbHl0aWNzV3JpdGVyLmNzeCINCiNsb2FkICJ3b3Jrc3BhY2UuY3N4Ig0KdXNpbmcgU3lzdGVtLk5ldDsNCnVzaW5nIE5ld3RvbnNvZnQuSnNvbjsNCnB1YmxpYyBzdGF0aWMgYXN5bmMgVGFzazxIdHRwUmVzcG9uc2VNZXNzYWdlPiBSdW4oSHR0cFJlcXVlc3RNZXNzYWdlIHJlcSwgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIGxvZy5JbmZvKCJDIyBIVFRQIHRyaWdnZXIgZnVuY3Rpb24gcHJvY2Vzc2VkIGEgcmVxdWVzdC4iKTsNCg0KCS8vIEdldCByZXF1ZXN0IGJvZHkNCgl2YXIgYm9keSA9IGF3YWl0IHJlcS5Db250ZW50LlJlYWRBc1N0cmluZ0FzeW5jKCk7DQogICAgc3RyaW5nW10gbG9ncyA9IGJvZHkuU3BsaXQoJ30nKTsNCg0KICAgIExvZ0FuYWx5dGljc1dyaXRlciBsYXcgPSBuZXcgTG9nQW5hbHl0aWNzV3JpdGVyKGN1c3RvbWVySWQsIHNoYXJlZEtleSwgbG9nKTsNCiAgICBBdXRvbWF0ZUxvZyBkYXRhID0gbmV3IEF1dG9tYXRlTG9nKCk7DQogICAgZm9yZWFjaChzdHJpbmcgaXRlbSBpbiBsb2dzKXsNCiAgICAgICAgc3RyaW5nIGFwcGVuZGVkSXRlbSA9IGl0ZW07DQogICAgICAgIGlmKCFhcHBlbmRlZEl0ZW0uRW5kc1dpdGgoIn0iKSl7DQogICAgICAgICAgICBhcHBlbmRlZEl0ZW0gPSBhcHBlbmRlZEl0ZW0gKyAnfSc7DQogICAgICAgIH0NCiAgICAgICAgbG9nLkluZm8oaXRlbSk7DQogICAgICAgIGlmKGl0ZW0gIT0gc3RyaW5nLkVtcHR5KXsNCgkgICAgICAgIGRhdGEgPSBKc29uQ29udmVydC5EZXNlcmlhbGl6ZU9iamVjdDxBdXRvbWF0ZUxvZz4oYXBwZW5kZWRJdGVtIGFzIHN0cmluZyk7DQogICAgICAgICAgICBBdXRvbWF0ZU1lc3NhZ2UgYXV0b21hdGVNZXNzYWdlID0gQXV0b21hdGVMb2dQYXJzZXIuUGFyc2VHZW5lcmljTG9nTWVzc2FnZShkYXRhLk1FU1NBR0VfcywgbG9nKTsNCiAgICAgICAgICAgIGxvZy5JbmZvKGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlKTsNCiAgICAgICAgICAgIGlmKGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlICE9ICJVbmtub3duIEVudHJ5Iil7DQogICAgICAgICAgICAgICAgc3RyaW5nIGxvZ05hbWUgPSBhdXRvbWF0ZU1lc3NhZ2Uuc291cmNlUGFja2FnZSArICJsb2ciOw0KICAgICAgICAgICAgICAgIGxhdy5TdWJtaXQoYXV0b21hdGVNZXNzYWdlLCBsb2dOYW1lKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCglsb2cuSW5mbyhkYXRhLl9IT1NUTkFNRSk7DQoNCg0KICAgIHJldHVybiBkYXRhLk1FU1NBR0VfcyA9PSBudWxsDQogICAgICAgID8gcmVxLkNyZWF0ZVJlc3BvbnNlKEh0dHBTdGF0dXNDb2RlLkJhZFJlcXVlc3QsICJQbGVhc2UgcGFzcyBhIG5hbWUgb24gdGhlIHF1ZXJ5IHN0cmluZyBvciBpbiB0aGUgcmVxdWVzdCBib2R5IikNCiAgICAgICAgOiByZXEuQ3JlYXRlUmVzcG9uc2UoSHR0cFN0YXR1c0NvZGUuT0ssICJIZWxsbyAiICsgZGF0YS5NRVNTQUdFX3MpOw0KfQ0KDQo=",
            "AutomateLogParser_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNsb2FkICJBdXRvbWF0ZU1lc3NhZ2UuY3N4Ig0KdXNpbmcgU3lzdGVtLk5ldDsNCnVzaW5nIE5ld3RvbnNvZnQuSnNvbjsNCnVzaW5nIFN5c3RlbS5UZXh0LlJlZ3VsYXJFeHByZXNzaW9uczsNCnVzaW5nIFN5c3RlbS5HbG9iYWxpemF0aW9uOw0KDQpwdWJsaWMgc3RhdGljIGNsYXNzIEF1dG9tYXRlTG9nUGFyc2Vyew0KICAgIHB1YmxpYyBzdGF0aWMgQXV0b21hdGVNZXNzYWdlIFBhcnNlR2VuZXJpY0xvZ01lc3NhZ2Uoc3RyaW5nIGxvZ01lc3NhZ2UsIFRyYWNlV3JpdGVyIGxvZyl7DQogICAgICAgIGlmKGxvZ01lc3NhZ2UuQ29udGFpbnMoImF1dG9tYXRlLWxvYWQtYmFsYW5jZXIiKSl7DQogICAgICAgICAgICByZXR1cm4gUGFyZXNBdXRvbWF0ZUxvYWRCYWxhbmNlckxvZyhsb2dNZXNzYWdlLCBsb2cpOw0KICAgICAgICB9DQogICAgICAgIGVsc2V7DQogICAgICAgICAgICBBdXRvbWF0ZU1lc3NhZ2UgYXV0b21hdGVNZXNzYWdlID0gbmV3IEF1dG9tYXRlTWVzc2FnZSgpOw0KICAgICAgICAgICAgYXV0b21hdGVNZXNzYWdlLnNvdXJjZVBhY2thZ2UgPSAiVW5rbm93biBFbnRyeSI7DQogICAgICAgICAgICByZXR1cm4gYXV0b21hdGVNZXNzYWdlOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBBdXRvbWF0ZU1lc3NhZ2UgUGFyZXNBdXRvbWF0ZUxvYWRCYWxhbmNlckxvZyhzdHJpbmcgbG9nTWVzc2FnZSwgVHJhY2VXcml0ZXIgbG9nKXsNCiAgICAgICAgUmVnZXggcnggPSBuZXcgUmVnZXgoQCIoLiopIFxbKC4qKVxdICAiIiguKikiIiAoXGQrKSAiIiguKikiIiAoXGQrKSAiIiguKikiIiAiIiguKikiIiAiIiguKikiIiAiIiguKikiIiAiIiguKikiIiAoXGQrKSIpOw0KICAgICAgICBNYXRjaCBtID0gcnguTWF0Y2gobG9nTWVzc2FnZSk7DQoNCiAgICAgICAgQ3VsdHVyZUluZm8gcHJvdmlkZXIgPSBDdWx0dXJlSW5mby5JbnZhcmlhbnRDdWx0dXJlOw0KCQlzdHJpbmcgZGF0ZUZvcm1hdCA9ICJkZC9NTU0veXl5eTpISDptbTpzcyArZmZmZiI7ICAgICAgIA0KICAgICAgICBsb2cuSW5mbygiPT1EIEEgVCBFIFQgSSBNIEU9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Iik7DQogICAgICAgIGxvZy5JbmZvKG0uR3JvdXBzWzJdLlRvU3RyaW5nKCkpOw0KICAgICAgICBsb2cuSW5mbygiPT1EIEEgVCBFIFQgSSBNIEU9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Iik7DQoNCiAgICAgICAgQXV0b21hdGVNZXNzYWdlIGF1dG9tYXRlTWVzc2FnZSA9IG5ldyBBdXRvbWF0ZU1lc3NhZ2UoKTsNCiAgICAgICAgYXV0b21hdGVNZXNzYWdlLnNvdXJjZVBhY2thZ2UgPSAiYXV0b21hdGUtbG9hZC1iYWxhbmNlciI7DQogICAgICAgIGF1dG9tYXRlTWVzc2FnZS50aW1lID0gRGF0ZVRpbWUuUGFyc2VFeGFjdChtLkdyb3Vwc1syXS5Ub1N0cmluZygpLCBkYXRlRm9ybWF0LCBDdWx0dXJlSW5mby5JbnZhcmlhbnRDdWx0dXJlKTsNCiAgICAgICAgYXV0b21hdGVNZXNzYWdlLm1lc3NhZ2UgPSBtLkdyb3Vwc1szXS5Ub1N0cmluZygpOw0KICAgICAgICBhdXRvbWF0ZU1lc3NhZ2Uuc3RhdHVzID0gbS5Hcm91cHNbNF0uVG9TdHJpbmcoKTsNCiAgICAgICAgcmV0dXJuIGF1dG9tYXRlTWVzc2FnZTsNCiAgICB9DQp9DQo=",
            "AutomateMessage_csx": "dXNpbmcgU3lzdGVtLk5ldDsNCnVzaW5nIFN5c3RlbS5UZXh0LlJlZ3VsYXJFeHByZXNzaW9uczsNCg0KcHVibGljIGNsYXNzIEF1dG9tYXRlTWVzc2FnZXsNCiAgICBwdWJsaWMgc3RyaW5nIHNvdXJjZVBhY2thZ2UgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBzdHJpbmcgbG9nTGV2ZWwgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBEYXRlVGltZSB0aW1lIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIG1lc3NhZ2UgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBzdHJpbmcgam9iIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIGZ1bmN0aW9uIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIHN0YXR1cyB7IGdldDsgc2V0OyB9DQoNCiAgICBwdWJsaWMgc3RyaW5nIEdldExvZ0ZyaWVuZGx5UGFja2FnZU5hbWUoKXsNCiAgICAgICAgc3RyaW5nIHN0ciA9IHNvdXJjZVBhY2thZ2U7DQogICAgICAgIA0KICAgICAgICBSZWdleCByZ3ggPSBuZXcgUmVnZXgoIlteYS16QS1aMC05XSIpOw0KICAgICAgICBzdHIgPSByZ3guUmVwbGFjZShzdHIsICIiKSArICJsb2ciOw0KDQogICAgICAgIHJldHVybiBzdHI7DQogICAgfQ0KfQ0K",
            "LogAnalyticsWriter_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCnVzaW5nIFN5c3RlbTsNCnVzaW5nIFN5c3RlbS5OZXQ7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHA7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHAuSGVhZGVyczsNCnVzaW5nIFN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHk7DQp1c2luZyBTeXN0ZW0uVGV4dDsNCnVzaW5nIFN5c3RlbS5UaHJlYWRpbmcuVGFza3M7DQp1c2luZyBOZXd0b25zb2Z0Lkpzb247DQoNCnB1YmxpYyBjbGFzcyBMb2dBbmFseXRpY3NXcml0ZXIgew0KICAgICAgICAvLyBVcGRhdGUgY3VzdG9tZXJJZCB0byB5b3VyIE9wZXJhdGlvbnMgTWFuYWdlbWVudCBTdWl0ZSB3b3Jrc3BhY2UgSUQNCiAgICAgICAgc3RyaW5nIEN1c3RvbWVySWQ7DQogICAgICAgIC8vIEZvciBzaGFyZWRLZXksIHVzZSBlaXRoZXIgdGhlIHByaW1hcnkgb3IgdGhlIHNlY29uZGFyeSBDb25uZWN0ZWQgU291cmNlcyBjbGllbnQgYXV0aGVudGljYXRpb24ga2V5ICAgDQogICAgICAgIHN0cmluZyBTaGFyZWRLZXk7DQogICAgICAgIFRyYWNlV3JpdGVyIEFGTG9nOw0KDQogICAgcHVibGljIExvZ0FuYWx5dGljc1dyaXRlcihzdHJpbmcgY3VzdG9tZXJJZCwgc3RyaW5nIHNoYXJlZEtleSwgVHJhY2VXcml0ZXIgbG9nKXsNCiAgICAgICAgQ3VzdG9tZXJJZCA9IGN1c3RvbWVySWQ7DQogICAgICAgIFNoYXJlZEtleSA9IHNoYXJlZEtleTsNCiAgICAgICAgQUZMb2cgPSBsb2c7DQogICAgICAgIEFGTG9nLkluZm8oQ3VzdG9tZXJJZCk7DQogICAgfQ0KDQogICAgLy8gQnVpbGQgdGhlIEFQSSBzaWduYXR1cmUNCiAgICBwcml2YXRlIHN0cmluZyBCdWlsZFNpZ25hdHVyZShzdHJpbmcgbWVzc2FnZSwgc3RyaW5nIHNlY3JldCkNCiAgICB7DQogICAgICAgIHZhciBlbmNvZGluZyA9IG5ldyBTeXN0ZW0uVGV4dC5BU0NJSUVuY29kaW5nKCk7DQogICAgICAgIGJ5dGVbXSBrZXlCeXRlID0gQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKHNlY3JldCk7DQogICAgICAgIGJ5dGVbXSBtZXNzYWdlQnl0ZXMgPSBlbmNvZGluZy5HZXRCeXRlcyhtZXNzYWdlKTsNCiAgICAgICAgdXNpbmcgKHZhciBobWFjc2hhMjU2ID0gbmV3IEhNQUNTSEEyNTYoa2V5Qnl0ZSkpDQogICAgICAgIHsNCiAgICAgICAgICAgIGJ5dGVbXSBoYXNoID0gaG1hY3NoYTI1Ni5Db21wdXRlSGFzaChtZXNzYWdlQnl0ZXMpOw0KICAgICAgICAgICAgQUZMb2cuSW5mbygiaW4gYnVpbGQgZnVuY3Rpb24gNSIpOw0KICAgICAgICAgICAgcmV0dXJuIENvbnZlcnQuVG9CYXNlNjRTdHJpbmcoaGFzaCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwcml2YXRlIHZvaWQgUG9zdERhdGEoc3RyaW5nIHNpZ25hdHVyZSwgc3RyaW5nIGpzb24sIHN0cmluZyBsb2dOYW1lLCBzdHJpbmcgZGF0ZSwgc3RyaW5nIHRpbWVzdGFtcCA9ICIiKQ0KICAgIHsgICAgICAgDQogICAgICAgIHRyeQ0KICAgICAgICB7DQogICAgICAgICAgICBzdHJpbmcgdXJsID0gImh0dHBzOi8vIiArIEN1c3RvbWVySWQgKyAiLm9kcy5vcGluc2lnaHRzLmF6dXJlLmNvbS9hcGkvbG9ncz9hcGktdmVyc2lvbj0yMDE2LTA0LTAxIjsNCiAgICAgICAgICAgIEFGTG9nLkluZm8odXJsKTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50IGNsaWVudCA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCgpOw0KICAgICAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7DQogICAgICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiTG9nLVR5cGUiLCBsb2dOYW1lKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJBdXRob3JpemF0aW9uIiwgc2lnbmF0dXJlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ4LW1zLWRhdGUiLCBkYXRlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ0aW1lLWdlbmVyYXRlZC1maWVsZCIsIHRpbWVzdGFtcCk7DQogICAgDQogICAgICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENvbnRlbnQgaHR0cENvbnRlbnQgPSBuZXcgU3RyaW5nQ29udGVudChqc29uLCBFbmNvZGluZy5VVEY4KTsNCiAgICAgICAgICAgIGh0dHBDb250ZW50LkhlYWRlcnMuQ29udGVudFR5cGUgPSBuZXcgTWVkaWFUeXBlSGVhZGVyVmFsdWUoImFwcGxpY2F0aW9uL2pzb24iKTsNCiAgICAgICAgICAgIFRhc2s8U3lzdGVtLk5ldC5IdHRwLkh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LlBvc3RBc3luYyhuZXcgVXJpKHVybCksIGh0dHBDb250ZW50KTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCByZXNwb25zZUNvbnRlbnQgPSByZXNwb25zZS5SZXN1bHQuQ29udGVudDsNCiAgICAgICAgICAgIHN0cmluZyByZXN1bHQgPSByZXNwb25zZUNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKS5SZXN1bHQ7DQogICAgICAgICAgICBBRkxvZy5JbmZvKCJSZXR1cm4gUmVzdWx0OiAiICsgcmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4Y2VwKQ0KICAgICAgICB7DQogICAgICAgICAgICBBRkxvZy5FcnJvcigiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCBTdWJtaXQoQXV0b21hdGVNZXNzYWdlIGF1dG9tYXRlTWVzc2FnZSwgc3RyaW5nIGxvZ05hbWUpew0KICAgICAgICB2YXIganNvbiA9IEpzb25Db252ZXJ0LlNlcmlhbGl6ZU9iamVjdChhdXRvbWF0ZU1lc3NhZ2UpOw0KDQogICAgICAgIHZhciBkYXRlc3RyaW5nID0gRGF0ZVRpbWUuVXRjTm93LlRvU3RyaW5nKCJyIik7DQogICAgICAgIHN0cmluZyBzdHJpbmdUb0hhc2ggPSAiUE9TVFxuIiArIGpzb24uTGVuZ3RoICsgIlxuYXBwbGljYXRpb24vanNvblxuIiArICJ4LW1zLWRhdGU6IiArIGRhdGVzdHJpbmcgKyAiXG4vYXBpL2xvZ3MiOw0KICAgICAgICBzdHJpbmcgaGFzaGVkU3RyaW5nID0gQnVpbGRTaWduYXR1cmUoc3RyaW5nVG9IYXNoLCBTaGFyZWRLZXkpOw0KICAgICAgICBzdHJpbmcgc2lnbmF0dXJlID0gIlNoYXJlZEtleSAiICsgQ3VzdG9tZXJJZCArICI6IiArIGhhc2hlZFN0cmluZzsNCg0KICAgICAgICBzdHJpbmcgdGltZXN0YW1wID0gYXV0b21hdGVNZXNzYWdlLnRpbWUuVG9TdHJpbmcoIllZWVktTU0tRERUaGg6bW06c3NaIik7DQogICAgICAgIEFGTG9nLkluZm8odGltZXN0YW1wKTsNCg0KICAgICAgICBBRkxvZy5JbmZvKCJzdWJtaXRpbmcgbG9nIik7DQogICAgICAgIFBvc3REYXRhKHNpZ25hdHVyZSwganNvbiwgbG9nTmFtZSwgZGF0ZXN0cmluZywgdGltZXN0YW1wKTsNCiAgICB9DQoNCn0="
        },
        "logAnalytics": {
            "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
            "shared_key": "[parameters('logAnalyticsSharedKey')]",
            "enabled": "[parameters('logAnalyticsEnabled')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "condition": "[variables('logAnalytics').enabled]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "authLevel": "function",
                            "name": "req",
                            "type": "httpTrigger",
                            "direction": "in",
                            "methods": [
                                "get",
                                "post"
                            ]
                        },
                        {
                            "name": "$return",
                            "type": "http",
                            "direction": "out"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "AutomateLog.csx": "[base64ToString(variables('code').AutomateLog_csx)]",
                    "AutomateLogParser.csx": "[base64ToString(variables('code').AutomateLogParser_csx)]",
                    "AutomateMessage.csx": "[base64ToString(variables('code').AutomateMessage_csx)]",
                    "LogAnalyticsWriter.csx": "[base64ToString(variables('code').LogAnalyticsWriter_csx)]",
                    "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string sharedKey = \"', variables('logAnalytics').shared_key, '\";\nstatic string customerName = \"', variables('name').customer, '\";\nstatic string subscriptionId = \"', subscription().subscriptionId, '\";')]",
                    "run.csx": "[base64ToString(variables('code').run_csx)]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "[if(variables('logAnalytics').enabled, parameters('functionName'), '')]"
        },
        "apiKey": {
            "type": "string",
            "value": "[if(variables('logAnalytics').enabled, listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key, '')]"
        }
    }
}