{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "siteName": {
          "type": "string",
          "metadata": {
              "description": "Name of the site into which the function should be deployed"
          }
      },
      "functionName": {
          "type": "string",
          "metadata": {
              "description": "name of the function"
          },
          "defaultValue": "chefServerMetrics"
      },
      "logAnalyticsEnabled": {
          "type": "bool"
      }
  },
  "variables": {
      "name": {
          "site": "[parameters('siteName')]",
          "function": "[parameters('functionName')]"
      },
      "apiVersions": {
          "functions": "2016-08-01"
      },
      "code": {
          "run_csx": "DQojciAiTmV3dG9uc29mdC5Kc29uIg0KDQojbG9hZCAiTG9nQW5hbHl0aWNzV3JpdGVyLmNzeCINCiNsb2FkICJDaGVmTWV0cmljTWVzc2FnZS5jc3giDQojbG9hZCAid29ya3NwYWNlLmNzeCINCg0KdXNpbmcgU3lzdGVtOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uLkxpbnE7DQoNCnB1YmxpYyBzdGF0aWMgdm9pZCBSdW4oc3RyaW5nIHJhd21ldHJpYywgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIGxvZy5JbmZvKCQiQyMgUXVldWUgdHJpZ2dlciBmdW5jdGlvbiBwcm9jZXNzZWQ6IHtyYXdtZXRyaWN9Iik7DQoNCiAgICAvLyBJbml0YWxpc2UgdmFyaWFibGVzDQogICAgU3lzdGVtLkRhdGVUaW1lIGRhdGVUaW1lID0gbmV3IFN5c3RlbS5EYXRlVGltZSgxOTcwLCAxLCAxLCAwLCAwLCAwLCAwKTsNCiAgICBMb2dBbmFseXRpY3NXcml0ZXIgbGF3ID0gbmV3IExvZ0FuYWx5dGljc1dyaXRlcihjdXN0b21lcklkLCBzaGFyZWRLZXksIGxvZyk7DQoNCiAgICAvLyBQYXJzZSB0aGUgcmF3IG1ldHJpYyBqc29uIGludG8gYW4gb2JqZWN0DQogICAgTmV3dG9uc29mdC5Kc29uLkxpbnEuSk9iamVjdCBzdGF0c2QgPSBOZXd0b25zb2Z0Lkpzb24uTGlucS5KT2JqZWN0LlBhcnNlKHJhd21ldHJpYyk7DQoNCiAgICAvLyBJdGVyYXRlIGFyb3VuZCB0aGUgc2VyaWVzIGRhdGEgYW5kIGNyZWF0ZSBhIG1lc3NhZ2UgZm9yIGVhY2ggb25lDQogICAgdmFyIG1ldHJpY3MgPSAoSkFycmF5KSBzdGF0c2RbInNlcmllcyJdOw0KICAgIGZvcmVhY2ggKEpPYmplY3QgbWV0cmljIGluIG1ldHJpY3MpIHsNCg0KICAgICAgICAvLyBjcmVhdGUgbWVzc2FnZSB0byBzZW5kIHRvIExvZyBBbmFseXRpY3MNCiAgICAgICAgQ2hlZk1ldHJpY01lc3NhZ2UgbWVzc2FnZSA9IG5ldyBDaGVmTWV0cmljTWVzc2FnZSgpOw0KDQogICAgICAgIC8vIGRldGVybWluZSB0aGUgdGltZSBvZiB0aGUgZXZlbnQNCiAgICAgICAgRGF0ZVRpbWUgdGltZSA9IGRhdGVUaW1lLkFkZFNlY29uZHMoKGRvdWJsZSkgbWV0cmljWyJwb2ludHMiXVswXVswXSk7DQoNCiAgICAgICAgLy8gc2V0IHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBvYmplY3QNCiAgICAgICAgbWVzc2FnZS5jbV9uYW1lID0gKHN0cmluZykgbWV0cmljWyJtZXRyaWMiXTsNCiAgICAgICAgbWVzc2FnZS5jbV90eXBlID0gKHN0cmluZykgbWV0cmljWyJ0eXBlIl07DQogICAgICAgIG1lc3NhZ2UuY21faG9zdCA9IChzdHJpbmcpIG1ldHJpY1siaG9zdCJdOw0KICAgICAgICBtZXNzYWdlLmNtX3RpbWUgPSB0aW1lOw0KICAgICAgICBtZXNzYWdlLmNtX3ZhbHVlID0gKGRvdWJsZSkgbWV0cmljWyJwb2ludHMiXVswXVsxXTsNCg0KICAgICAgICAvLyBTdWJtaXQgdGhlIG1ldHJpYyB0byBMb2cgQW5hbHl0aWNzDQogICAgICAgIGxhdy5TdWJtaXQobWVzc2FnZSwgInN0YXRzZF9sb2ciKTsNCiAgICB9DQoNCn0NCg=="
      },
      "logAnalytics": {
          "enabled": "[parameters('logAnalyticsEnabled')]"
      }
  },
  "resources": [
      {
          "type": "Microsoft.Web/sites/functions",
          "name": "[concat(variables('name').site, '/', variables('name').function)]",
          "condition": "[variables('logAnalytics').enabled]",
          "apiVersion": "[variables('apiVersions').functions]",
          "properties": {
              "config": {
                  "bindings": [
                    {
                      "name": "rawmetric",
                      "type": "queueTrigger",
                      "direction": "in",
                      "queueName": "chef-statsd",
                      "connection": "AzureWebJobsStorage"
                    }
                  ],
                  "disabled": false
              },
              "files": {
                  "run.csx": "[base64ToString(variables('code').run_csx)]"
              }
          }
      }
  ],
  "outputs": {
      "name": {
          "type": "string",
          "value": "[if(variables('logAnalytics').enabled, parameters('functionName'), '')]"
      },
      "apiKey": {
          "type": "string",
          "value": "[if(variables('logAnalytics').enabled, listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key, '')]"
      }
  }
}