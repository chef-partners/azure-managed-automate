{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
      "siteName": {
          "type": "string",
          "metadata": {
              "description": "Name of the site into which the function should be deployed"
          }
      },
      "functionName": {
          "type": "string",
          "metadata": {
              "description": "name of the function"
          },
          "defaultValue": "chefServerMetrics"
      },
      "logAnalyticsWorkspaceID": {
          "type": "string",
          "metadata": {
              "description": "The workspace ID to use when adding data to Log Analytics"
          }
      },
      "logAnalyticsSharedKey": {
          "type": "securestring",
          "metadata": {
              "description": "Primary key to use for authentication to Log Analytics"
          }
      },
      "logAnalyticsEnabled": {
          "type": "bool"
      },
        "customerName": {
            "type": "string",
            "defaultValue": ""
        }
  },
  "variables": {
      "name": {
          "site": "[parameters('siteName')]",
          "function": "[parameters('functionName')]",
          "customer": "[parameters('customerName')]"
      },
      "apiVersions": {
          "functions": "2016-08-01"
      },
      "code": {
          "ChefMetricMessage_csx": "dXNpbmcgU3lzdGVtLk5ldDsNCnVzaW5nIFN5c3RlbS5UZXh0LlJlZ3VsYXJFeHByZXNzaW9uczsNCg0KcHVibGljIGNsYXNzIENoZWZNZXRyaWNNZXNzYWdlIHsNCiAgICBwdWJsaWMgRGF0ZVRpbWUgY21fdGltZSB7IGdldDsgc2V0OyB9DQogICAgcHVibGljIHN0cmluZyBjbV9uYW1lIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgc3RyaW5nIGNtX3R5cGUgeyBnZXQ7IHNldDsgfQ0KICAgIHB1YmxpYyBzdHJpbmcgY21faG9zdCB7IGdldDsgc2V0OyB9DQogICAgcHVibGljIGRvdWJsZSBjbV92YWx1ZSB7IGdldDsgc2V0OyB9IA0KfQ==",
          "run_csx": "DQojciAiTmV3dG9uc29mdC5Kc29uIg0KDQojbG9hZCAiTG9nQW5hbHl0aWNzV3JpdGVyLmNzeCINCiNsb2FkICJDaGVmTWV0cmljTWVzc2FnZS5jc3giDQojbG9hZCAid29ya3NwYWNlLmNzeCINCg0KdXNpbmcgU3lzdGVtOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uLkxpbnE7DQoNCnB1YmxpYyBzdGF0aWMgdm9pZCBSdW4oc3RyaW5nIHJhd21ldHJpYywgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIGxvZy5JbmZvKCQiQyMgUXVldWUgdHJpZ2dlciBmdW5jdGlvbiBwcm9jZXNzZWQ6IHtyYXdtZXRyaWN9Iik7DQoNCiAgICAvLyBJbml0YWxpc2UgdmFyaWFibGVzDQogICAgU3lzdGVtLkRhdGVUaW1lIGRhdGVUaW1lID0gbmV3IFN5c3RlbS5EYXRlVGltZSgxOTcwLCAxLCAxLCAwLCAwLCAwLCAwKTsNCiAgICBMb2dBbmFseXRpY3NXcml0ZXIgbGF3ID0gbmV3IExvZ0FuYWx5dGljc1dyaXRlcihjdXN0b21lcklkLCBzaGFyZWRLZXksIGxvZyk7DQoNCiAgICAvLyBQYXJzZSB0aGUgcmF3IG1ldHJpYyBqc29uIGludG8gYW4gb2JqZWN0DQogICAgTmV3dG9uc29mdC5Kc29uLkxpbnEuSk9iamVjdCBzdGF0c2QgPSBOZXd0b25zb2Z0Lkpzb24uTGlucS5KT2JqZWN0LlBhcnNlKHJhd21ldHJpYyk7DQoNCiAgICAvLyBJdGVyYXRlIGFyb3VuZCB0aGUgc2VyaWVzIGRhdGEgYW5kIGNyZWF0ZSBhIG1lc3NhZ2UgZm9yIGVhY2ggb25lDQogICAgdmFyIG1ldHJpY3MgPSAoSkFycmF5KSBzdGF0c2RbInNlcmllcyJdOw0KICAgIGZvcmVhY2ggKEpPYmplY3QgbWV0cmljIGluIG1ldHJpY3MpIHsNCg0KICAgICAgICAvLyBjcmVhdGUgbWVzc2FnZSB0byBzZW5kIHRvIExvZyBBbmFseXRpY3MNCiAgICAgICAgQ2hlZk1ldHJpY01lc3NhZ2UgbWVzc2FnZSA9IG5ldyBDaGVmTWV0cmljTWVzc2FnZSgpOw0KDQogICAgICAgIC8vIGRldGVybWluZSB0aGUgdGltZSBvZiB0aGUgZXZlbnQNCiAgICAgICAgRGF0ZVRpbWUgdGltZSA9IGRhdGVUaW1lLkFkZFNlY29uZHMoKGRvdWJsZSkgbWV0cmljWyJwb2ludHMiXVswXVswXSk7DQoNCiAgICAgICAgLy8gc2V0IHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBvYmplY3QNCiAgICAgICAgbWVzc2FnZS5jbV9uYW1lID0gKHN0cmluZykgbWV0cmljWyJtZXRyaWMiXTsNCiAgICAgICAgbWVzc2FnZS5jbV90eXBlID0gKHN0cmluZykgbWV0cmljWyJ0eXBlIl07DQogICAgICAgIG1lc3NhZ2UuY21faG9zdCA9IChzdHJpbmcpIG1ldHJpY1siaG9zdCJdOw0KICAgICAgICBtZXNzYWdlLmNtX3RpbWUgPSB0aW1lOw0KICAgICAgICBtZXNzYWdlLmNtX3ZhbHVlID0gKGRvdWJsZSkgbWV0cmljWyJwb2ludHMiXVswXVsxXTsNCg0KICAgICAgICAvLyBTdWJtaXQgdGhlIG1ldHJpYyB0byBMb2cgQW5hbHl0aWNzDQogICAgICAgIGxhdy5TdWJtaXQobWVzc2FnZSwgInN0YXRzZF9sb2ciKTsNCiAgICB9DQoNCn0NCg==",
          "LogAnalyticsWriter_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCnVzaW5nIFN5c3RlbTsNCnVzaW5nIFN5c3RlbS5OZXQ7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHA7DQp1c2luZyBTeXN0ZW0uTmV0Lkh0dHAuSGVhZGVyczsNCnVzaW5nIFN5c3RlbS5TZWN1cml0eS5DcnlwdG9ncmFwaHk7DQp1c2luZyBTeXN0ZW0uVGV4dDsNCnVzaW5nIFN5c3RlbS5UaHJlYWRpbmcuVGFza3M7DQp1c2luZyBOZXd0b25zb2Z0Lkpzb247DQoNCnB1YmxpYyBjbGFzcyBMb2dBbmFseXRpY3NXcml0ZXIgew0KICAgICAgICAvLyBVcGRhdGUgY3VzdG9tZXJJZCB0byB5b3VyIE9wZXJhdGlvbnMgTWFuYWdlbWVudCBTdWl0ZSB3b3Jrc3BhY2UgSUQNCiAgICAgICAgc3RyaW5nIEN1c3RvbWVySWQ7DQogICAgICAgIC8vIEZvciBzaGFyZWRLZXksIHVzZSBlaXRoZXIgdGhlIHByaW1hcnkgb3IgdGhlIHNlY29uZGFyeSBDb25uZWN0ZWQgU291cmNlcyBjbGllbnQgYXV0aGVudGljYXRpb24ga2V5ICAgDQogICAgICAgIHN0cmluZyBTaGFyZWRLZXk7DQogICAgICAgIFRyYWNlV3JpdGVyIEFGTG9nOw0KDQogICAgcHVibGljIExvZ0FuYWx5dGljc1dyaXRlcihzdHJpbmcgY3VzdG9tZXJJZCwgc3RyaW5nIHNoYXJlZEtleSwgVHJhY2VXcml0ZXIgbG9nKXsNCiAgICAgICAgQ3VzdG9tZXJJZCA9IGN1c3RvbWVySWQ7DQogICAgICAgIFNoYXJlZEtleSA9IHNoYXJlZEtleTsNCiAgICAgICAgQUZMb2cgPSBsb2c7DQogICAgICAgIEFGTG9nLkluZm8oQ3VzdG9tZXJJZCk7DQogICAgfQ0KDQogICAgLy8gQnVpbGQgdGhlIEFQSSBzaWduYXR1cmUNCiAgICBwcml2YXRlIHN0cmluZyBCdWlsZFNpZ25hdHVyZShzdHJpbmcgbWVzc2FnZSwgc3RyaW5nIHNlY3JldCkNCiAgICB7DQogICAgICAgIHZhciBlbmNvZGluZyA9IG5ldyBTeXN0ZW0uVGV4dC5BU0NJSUVuY29kaW5nKCk7DQogICAgICAgIGJ5dGVbXSBrZXlCeXRlID0gQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKHNlY3JldCk7DQogICAgICAgIGJ5dGVbXSBtZXNzYWdlQnl0ZXMgPSBlbmNvZGluZy5HZXRCeXRlcyhtZXNzYWdlKTsNCiAgICAgICAgdXNpbmcgKHZhciBobWFjc2hhMjU2ID0gbmV3IEhNQUNTSEEyNTYoa2V5Qnl0ZSkpDQogICAgICAgIHsNCiAgICAgICAgICAgIGJ5dGVbXSBoYXNoID0gaG1hY3NoYTI1Ni5Db21wdXRlSGFzaChtZXNzYWdlQnl0ZXMpOw0KICAgICAgICAgICAgQUZMb2cuSW5mbygiaW4gYnVpbGQgZnVuY3Rpb24gNSIpOw0KICAgICAgICAgICAgcmV0dXJuIENvbnZlcnQuVG9CYXNlNjRTdHJpbmcoaGFzaCk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwcml2YXRlIHZvaWQgUG9zdERhdGEoc3RyaW5nIHNpZ25hdHVyZSwgc3RyaW5nIGpzb24sIHN0cmluZyBsb2dOYW1lLCBzdHJpbmcgZGF0ZSwgc3RyaW5nIHRpbWVzdGFtcCA9ICIiKQ0KICAgIHsgICAgICAgDQogICAgICAgIHRyeQ0KICAgICAgICB7DQogICAgICAgICAgICBzdHJpbmcgdXJsID0gImh0dHBzOi8vIiArIEN1c3RvbWVySWQgKyAiLm9kcy5vcGluc2lnaHRzLmF6dXJlLmNvbS9hcGkvbG9ncz9hcGktdmVyc2lvbj0yMDE2LTA0LTAxIjsNCiAgICAgICAgICAgIEFGTG9nLkluZm8odXJsKTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50IGNsaWVudCA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCgpOw0KICAgICAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7DQogICAgICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiTG9nLVR5cGUiLCBsb2dOYW1lKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJBdXRob3JpemF0aW9uIiwgc2lnbmF0dXJlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ4LW1zLWRhdGUiLCBkYXRlKTsNCiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ0aW1lLWdlbmVyYXRlZC1maWVsZCIsIHRpbWVzdGFtcCk7DQogICAgDQogICAgICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENvbnRlbnQgaHR0cENvbnRlbnQgPSBuZXcgU3RyaW5nQ29udGVudChqc29uLCBFbmNvZGluZy5VVEY4KTsNCiAgICAgICAgICAgIGh0dHBDb250ZW50LkhlYWRlcnMuQ29udGVudFR5cGUgPSBuZXcgTWVkaWFUeXBlSGVhZGVyVmFsdWUoImFwcGxpY2F0aW9uL2pzb24iKTsNCiAgICAgICAgICAgIFRhc2s8U3lzdGVtLk5ldC5IdHRwLkh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LlBvc3RBc3luYyhuZXcgVXJpKHVybCksIGh0dHBDb250ZW50KTsNCiAgICANCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCByZXNwb25zZUNvbnRlbnQgPSByZXNwb25zZS5SZXN1bHQuQ29udGVudDsNCiAgICAgICAgICAgIHN0cmluZyByZXN1bHQgPSByZXNwb25zZUNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKS5SZXN1bHQ7DQogICAgICAgICAgICBBRkxvZy5JbmZvKCJSZXR1cm4gUmVzdWx0OiAiICsgcmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4Y2VwKQ0KICAgICAgICB7DQogICAgICAgICAgICBBRkxvZy5FcnJvcigiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCBTdWJtaXQoQ2hlZk1ldHJpY01lc3NhZ2UgbWV0cmljTWVzc2FnZSwgc3RyaW5nIGxvZ05hbWUpew0KICAgICAgICB2YXIganNvbiA9IEpzb25Db252ZXJ0LlNlcmlhbGl6ZU9iamVjdChtZXRyaWNNZXNzYWdlKTsNCg0KICAgICAgICB2YXIgZGF0ZXN0cmluZyA9IERhdGVUaW1lLlV0Y05vdy5Ub1N0cmluZygiciIpOw0KICAgICAgICBzdHJpbmcgc3RyaW5nVG9IYXNoID0gIlBPU1RcbiIgKyBqc29uLkxlbmd0aCArICJcbmFwcGxpY2F0aW9uL2pzb25cbiIgKyAieC1tcy1kYXRlOiIgKyBkYXRlc3RyaW5nICsgIlxuL2FwaS9sb2dzIjsNCiAgICAgICAgc3RyaW5nIGhhc2hlZFN0cmluZyA9IEJ1aWxkU2lnbmF0dXJlKHN0cmluZ1RvSGFzaCwgU2hhcmVkS2V5KTsNCiAgICAgICAgc3RyaW5nIHNpZ25hdHVyZSA9ICJTaGFyZWRLZXkgIiArIEN1c3RvbWVySWQgKyAiOiIgKyBoYXNoZWRTdHJpbmc7DQoNCiAgICAgICAgc3RyaW5nIHRpbWVzdGFtcCA9IG1ldHJpY01lc3NhZ2UuY21fdGltZS5Ub1N0cmluZygieXl5eS1NTS1kZFRoaDptbTpzc1oiKTsNCiAgICAgICAgQUZMb2cuSW5mbyh0aW1lc3RhbXApOw0KDQogICAgICAgIEFGTG9nLkluZm8oInN1Ym1pdGluZyBsb2ciKTsNCiAgICAgICAgUG9zdERhdGEoc2lnbmF0dXJlLCBqc29uLCBsb2dOYW1lLCBkYXRlc3RyaW5nLCB0aW1lc3RhbXApOw0KICAgIH0NCg0KfQ=="
      },
      "logAnalytics": {
          "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
          "shared_key": "[parameters('logAnalyticsSharedKey')]",
          "enabled": "[parameters('logAnalyticsEnabled')]"
      }
  },
  "resources": [
      {
          "type": "Microsoft.Web/sites/functions",
          "name": "[concat(variables('name').site, '/', variables('name').function)]",
          "condition": "[variables('logAnalytics').enabled]",
          "apiVersion": "[variables('apiVersions').functions]",
          "properties": {
              "config": {
                  "bindings": [
                    {
                      "name": "rawmetric",
                      "type": "queueTrigger",
                      "direction": "in",
                      "queueName": "chef-statsd",
                      "connection": "AzureWebJobsStorage"
                    }
                  ],
                  "disabled": false
              },
              "files": {
                  "ChefMetricMessage.csx": "[base64ToString(variables('code').ChefMetricMessage_csx)]",
                  "LogAnalyticsWriter.csx": "[base64ToString(variables('code').LogAnalyticsWriter_csx)]",
                  "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string sharedKey = \"', variables('logAnalytics').shared_key, '\";\nstatic string customerName = \"', variables('name').customer, '\";\nstatic string subscriptionId = \"', subscription().id, '\";')]",
                  "run.csx": "[base64ToString(variables('code').run_csx)]"
              }
          }
      }
  ],
  "outputs": {
      "name": {
          "type": "string",
          "value": "[if(variables('logAnalytics').enabled, parameters('functionName'), '')]"
      },
      "apiKey": {
          "type": "string",
          "value": "[if(variables('logAnalytics').enabled, listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key, '')]"
      }
  }
}