{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "starterKit"
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "run_csx": "I3IgIk1pY3Jvc29mdC5XaW5kb3dzQXp1cmUuU3RvcmFnZSIKI3IgIlN5c3RlbS5JTy5Db21wcmVzc2lvbi5GaWxlc3lzdGVtIgoKI2xvYWQgImNvbnN0YW50cy5jc3giCgp1c2luZyBTeXN0ZW0uTmV0Owp1c2luZyBTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYzsKdXNpbmcgU3lzdGVtLlRleHQ7CnVzaW5nIFN5c3RlbS5JTy5Db21wcmVzc2lvbjsKdXNpbmcgTWljcm9zb2Z0LldpbmRvd3NBenVyZS5TdG9yYWdlOwp1c2luZyBNaWNyb3NvZnQuV2luZG93c0F6dXJlLlN0b3JhZ2UuVGFibGU7CgpwdWJsaWMgc3RhdGljIGFzeW5jIFRhc2s8SHR0cFJlc3BvbnNlTWVzc2FnZT4gUnVuKEh0dHBSZXF1ZXN0TWVzc2FnZSByZXEsIENsb3VkVGFibGUgc2V0dGluZ1RhYmxlLCBUcmFjZVdyaXRlciBsb2csIEV4ZWN1dGlvbkNvbnRleHQgZXhlY3V0aW9uQ29udGV4dCkKewoKICAgIC8vIEdldCBhbGwgdGhlIHNldHRpbmdzIGZyb20gdGhlIHRhYmxlIGludG8gYSBoYXNodGFibGUKICAgIERpY3Rpb25hcnk8c3RyaW5nLCBzdHJpbmc+IEFNQSA9IEdldEFNQShzZXR0aW5nVGFibGUpOwoKICAgIC8vIENyZWF0ZSBkaXJlY3Rvcnkgc3RydWN0dXJlIGZvciB0aGUgZmlsZXMgdGhhdCBuZWVkIHRvIGJlIHppcHBlZCB1cAogICAgc3RyaW5nIGNoZWZfcmVwb19wYXRoID0gUGF0aC5Db21iaW5lKGV4ZWN1dGlvbkNvbnRleHQuRnVuY3Rpb25EaXJlY3RvcnksICJjaGVmLXJlcG8iKTsKCiAgICAvLyBkZWxldGUgdGhlIHJlcG8gcGF0aCBpZiBpdCBhbHJlYWR5IGV4aXN0cwogICAgaWYgKERpcmVjdG9yeS5FeGlzdHMoY2hlZl9yZXBvX3BhdGgpKQogICAgewogICAgICAgIERpcmVjdG9yeS5EZWxldGUoY2hlZl9yZXBvX3BhdGgsIHRydWUpOwogICAgfQoKICAgIC8vIEJhc2U2NCBkZWNvZGUgdGhlIHVzZXIga2V5IGFuZCBzZXQgdGhlIHBhdGggdG8gdGhlIGZpbGUKICAgIHN0cmluZyBjbGllbnRfa2V5X2ZpbGVuYW1lID0gU3RyaW5nLkZvcm1hdCgiezB9LnBlbSIsIEFNQVtVc2VyS2V5XSk7CiAgICBzdHJpbmcgY2xpZW50X2tleV9wYXRoID0gUGF0aC5Db21iaW5lKGNoZWZfcmVwb19wYXRoLCAiLmNoZWYiLCBjbGllbnRfa2V5X2ZpbGVuYW1lKTsKICAgIHN0cmluZyB1c2VyX2tleSA9IEVuY29kaW5nLlVURjguR2V0U3RyaW5nKENvbnZlcnQuRnJvbUJhc2U2NFN0cmluZyhBTUFbVXNlcktleUtleV0pKTsKCiAgICAvLyBCYXNlNjQgZGVjb2RlIHRoZSB2YWxpZGF0b3Iga2V5IGFuZCBzZXQgdGhlIHBhdGggdG8gdGhlIGZpbGUKICAgIHN0cmluZyB2YWxpZGF0b3Jfa2V5X2ZpbGVuYW1lID0gU3RyaW5nLkZvcm1hdCgiezB9LXZhbGlkYXRvci5wZW0iLCBBTUFbT3JnS2V5XSk7CiAgICBzdHJpbmcgdmFsaWRhdG9yX2tleV9wYXRoID0gUGF0aC5Db21iaW5lKGNoZWZfcmVwb19wYXRoLCAiLmNoZWYiLCB2YWxpZGF0b3Jfa2V5X2ZpbGVuYW1lKTsKICAgIHN0cmluZyB2YWxpZGF0b3Jfa2V5ID0gRW5jb2RpbmcuVVRGOC5HZXRTdHJpbmcoQ29udmVydC5Gcm9tQmFzZTY0U3RyaW5nKEFNQVtPcmdLZXlLZXldKSk7CgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIHBhcmVudCBmb3IgdGhlIGNsaWVudF9rZXlfcGF0aCBleGlzdHMKICAgIGlmICghRGlyZWN0b3J5LkV4aXN0cyhEaXJlY3RvcnkuR2V0UGFyZW50KGNsaWVudF9rZXlfcGF0aCkuVG9TdHJpbmcoKSkpCiAgICB7CiAgICAgICAgRGlyZWN0b3J5LkNyZWF0ZURpcmVjdG9yeShEaXJlY3RvcnkuR2V0UGFyZW50KGNsaWVudF9rZXlfcGF0aCkuVG9TdHJpbmcoKSk7CiAgICB9CgogICAgLy8gV3JpdGUgdGhlIGNsaWVudCBhbmQgdmFsaWRhdGlvbiBrZXlzIG91dCB0byBhIGZpbGUKICAgIEZpbGUuV3JpdGVBbGxUZXh0KGNsaWVudF9rZXlfcGF0aCwgdXNlcl9rZXkpOwogICAgRmlsZS5Xcml0ZUFsbFRleHQodmFsaWRhdG9yX2tleV9wYXRoLCB2YWxpZGF0b3Jfa2V5KTsKCiAgICAvLyBDcmVhdGUgdGhlIENoZWYgQXV0b21hdGUgY3JlZGVudGlhbHMgZmlsZQogICAgc3RyaW5nIGNyZWRlbnRpYWxzX3BhdGggPSBQYXRoLkNvbWJpbmUoY2hlZl9yZXBvX3BhdGgsICJjcmVkZW50aWFscy50eHQiKTsKICAgIFN0cmluZ0J1aWxkZXIgc2IgPSBuZXcgU3RyaW5nQnVpbGRlcigpOwogICAgc2IuQXBwZW5kTGluZShTdHJpbmcuRm9ybWF0KCJBdXRvbWF0ZSBVUkw6IGh0dHBzOi8vezB9IiwgQU1BW0F1dG9tYXRlU2VydmVyRlFETktleV0pKTsKICAgIHNiLkFwcGVuZExpbmUoU3RyaW5nLkZvcm1hdCgiQ2hlZiBTZXJ2ZXIgVVJMOiBodHRwczovL3swfS9vcmdhbml6YXRpb25zL3sxfSIsIEFNQVtDaGVmU2VydmVyRlFETktleV0sIEFNQVtPcmdLZXldKSk7CiAgICBzYi5BcHBlbmRMaW5lKFN0cmluZy5Gb3JtYXQoIlVzZXIgdXNlcm5hbWU6IHswfSIsIEFNQVtVc2VyS2V5XSkpOwogICAgc2IuQXBwZW5kTGluZShTdHJpbmcuRm9ybWF0KCJVc2VyIHBhc3N3b3JkOiB7MH0iLCBBTUFbVXNlclBhc3N3b3JkS2V5XSkpOwogICAgRmlsZS5Xcml0ZUFsbFRleHQoY3JlZGVudGlhbHNfcGF0aCwgc2IuVG9TdHJpbmcoKSk7CiAgICAKCiAgICAvLyBSZWFkIGluIHRoZSBrbmlmZSBmaWxlIGFuZCBwYXRjaCBpdCBzbyB0aGF0IGl0IGhhcyB0aGUgY29ycmVjdCB2YWx1ZXMKICAgIHN0cmluZyBrbmlmZV9jb25maWcgPSBGaWxlLlJlYWRBbGxUZXh0KFBhdGguQ29tYmluZShleGVjdXRpb25Db250ZXh0LkZ1bmN0aW9uRGlyZWN0b3J5LCAia25pZmUucmIiKSk7CgogICAga25pZmVfY29uZmlnID0ga25pZmVfY29uZmlnLlJlcGxhY2UoInt7IE5PREVfTkFNRSB9fSIsIEFNQVtVc2VyS2V5XSk7CiAgICBrbmlmZV9jb25maWcgPSBrbmlmZV9jb25maWcuUmVwbGFjZSgie3sgQ0xJRU5UX0tFWV9GSUxFTkFNRSB9fSIsIGNsaWVudF9rZXlfZmlsZW5hbWUpOwogICAga25pZmVfY29uZmlnID0ga25pZmVfY29uZmlnLlJlcGxhY2UoInt7IE9SR19WQUxJREFUT1JfTkFNRSB9fSIsIFN0cmluZy5Gb3JtYXQoInswfS12YWxpZGF0b3IiLCBBTUFbT3JnS2V5XSkpOwogICAga25pZmVfY29uZmlnID0ga25pZmVfY29uZmlnLlJlcGxhY2UoInt7IE9SR19LRVlfRklMRU5BTUUgfX0iLCB2YWxpZGF0b3Jfa2V5X2ZpbGVuYW1lKTsKICAgIGtuaWZlX2NvbmZpZyA9IGtuaWZlX2NvbmZpZy5SZXBsYWNlKCJ7eyBDSEVGX1NFUlZFUl9VUkwgfX0iLCBTdHJpbmcuRm9ybWF0KCJodHRwczovL3swfS9vcmdhbml6YXRpb25zL3sxfSIsIEFNQVtDaGVmU2VydmVyRlFETktleV0sIEFNQVtPcmdLZXldKSk7CgogICAgLy8gV3JpdGUgb3V0IHRoZSBrbmlmZSBmaWxlIHRvIHRoZSByZXBvIGRpcmVjdG95cgogICAgc3RyaW5nIGtuaWZlX2ZpbGVfcGF0aCA9IFBhdGguQ29tYmluZShjaGVmX3JlcG9fcGF0aCwgIi5jaGVmIiwgImtuaWZlLnJiIik7CiAgICBGaWxlLldyaXRlQWxsVGV4dChrbmlmZV9maWxlX3BhdGgsIGtuaWZlX2NvbmZpZyk7CgogICAgLy8gWmlwIHVwIHRoZSBkaXJlY3RvcnkKICAgIHN0cmluZyB6aXBfcGF0aCA9IFBhdGguQ29tYmluZShleGVjdXRpb25Db250ZXh0LkZ1bmN0aW9uRGlyZWN0b3J5LCAic3RhcnRlcl9raXQuemlwIik7CgogICAgLy8gRGVsZXRlIHRoZSB6aXAgaWYgaXQgYWxyZWFkeSBleGlzdHMKICAgIGlmIChGaWxlLkV4aXN0cyh6aXBfcGF0aCkpCiAgICB7CiAgICAgICAgRmlsZS5EZWxldGUoemlwX3BhdGgpOwogICAgfQoKICAgIFppcEZpbGUuQ3JlYXRlRnJvbURpcmVjdG9yeShjaGVmX3JlcG9fcGF0aCwgemlwX3BhdGgpOwoKICAgIC8vIFR1cm4gdGhlIFppcCBmaWxlIGludG8gYSBieXRlIGFycmF5CiAgICB2YXIgZGF0YUJ5dGVzID0gRmlsZS5SZWFkQWxsQnl0ZXMoemlwX3BhdGgpOwogICAgdmFyIGRhdGFTdHJlYW0gPSBuZXcgTWVtb3J5U3RyZWFtKGRhdGFCeXRlcyk7CgogICAgLy8gQnVpbGQgdXAgdGhlIHJlc3BvbnNlIHNvIHRoYXQgdGhlIHppcCBmaWxlIGNhbiBiZSByZXR1cm5lZAogICAgSHR0cFJlc3BvbnNlTWVzc2FnZSByZXNwb25zZSA9IG5ldyBIdHRwUmVzcG9uc2VNZXNzYWdlKEh0dHBTdGF0dXNDb2RlLk9LKTsKICAgIHJlc3BvbnNlLkNvbnRlbnQgPSBuZXcgU3RyZWFtQ29udGVudChkYXRhU3RyZWFtKTsKICAgIHJlc3BvbnNlLkNvbnRlbnQuSGVhZGVycy5Db250ZW50RGlzcG9zaXRpb24gPSBuZXcgU3lzdGVtLk5ldC5IdHRwLkhlYWRlcnMuQ29udGVudERpc3Bvc2l0aW9uSGVhZGVyVmFsdWUoImF0dGFjaG1lbnQiKTsKICAgIHJlc3BvbnNlLkNvbnRlbnQuSGVhZGVycy5Db250ZW50RGlzcG9zaXRpb24uRmlsZU5hbWUgPSAic3RhcnRlcl9raXQuemlwIjsKICAgIHJlc3BvbnNlLkNvbnRlbnQuSGVhZGVycy5Db250ZW50VHlwZSA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSGVhZGVycy5NZWRpYVR5cGVIZWFkZXJWYWx1ZSgiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIik7CgogICAgLy8gUmVtb3ZlIHRoZSBjaGVmX3JlcG8gZGlyZWN0b3J5IGFuZCB0aGUgc3RhcnRlciBraXQKICAgIERpcmVjdG9yeS5EZWxldGUoY2hlZl9yZXBvX3BhdGgsIHRydWUpOwogICAgRmlsZS5EZWxldGUoemlwX3BhdGgpOwoKICAgIHJldHVybiByZXNwb25zZTsKfQoKcHVibGljIHN0YXRpYyBEaWN0aW9uYXJ5PHN0cmluZywgc3RyaW5nPiBHZXRBTUEgKENsb3VkVGFibGUgc2V0dGluZ1RhYmxlKSB7CgogICAgLy8gSW5pdGlhbGlzZSB0aGUgZGljdGlvbmFyeSB0aGF0IGlzIHRvIGJlIHJldHVybmVkCiAgICBEaWN0aW9uYXJ5PHN0cmluZywgc3RyaW5nPiBBTUEgPSBuZXcgRGljdGlvbmFyeTxzdHJpbmcsIHN0cmluZz4oKTsKCiAgICAvLyBjcmVhdGUgYSB0YWJsZSBxdWVyeSB0byBnZXQgYWxsIHRoZSBpbmZvcm1hdGlvbiBmcm9tIHRoZSB0YWJsZQogICAgVGFibGVRdWVyeTxDb25maWdLVj4gcXVlcnkgPSBuZXcgVGFibGVRdWVyeTxDb25maWdLVj4oKS5XaGVyZShUYWJsZVF1ZXJ5LkdlbmVyYXRlRmlsdGVyQ29uZGl0aW9uKCJQYXJ0aXRpb25LZXkiLCBRdWVyeUNvbXBhcmlzb25zLkVxdWFsLCBQYXJ0aXRpb25LZXkpKTsKCiAgICAvLyBpdGVyYXRlIGFyb3VuZCB0aGUgdGFibGUgYW5kIGdldCBhbGwgdGhlIHJlcXVpcmVkIHZhbHVlcwogICAgVGFibGVDb250aW51YXRpb25Ub2tlbiB0b2tlbiA9IG51bGw7CiAgICBkbwogICAgewogICAgICAgIFRhYmxlUXVlcnlTZWdtZW50PENvbmZpZ0tWPiByZXN1bHRTZWdtZW50ID0gc2V0dGluZ1RhYmxlLkV4ZWN1dGVRdWVyeVNlZ21lbnRlZChxdWVyeSwgdG9rZW4pOwogICAgICAgIHRva2VuID0gcmVzdWx0U2VnbWVudC5Db250aW51YXRpb25Ub2tlbjsKCiAgICAgICAgZm9yZWFjaCAoQ29uZmlnS1YgaXRlbSBpbiByZXN1bHRTZWdtZW50LlJlc3VsdHMpCiAgICAgICAgewogICAgICAgICAgICBBTUEuQWRkKGl0ZW0uUm93S2V5LCBpdGVtLlZhbHVlKTsKICAgICAgICB9CiAgICB9IHdoaWxlICh0b2tlbiAhPSBudWxsKTsKCiAgICByZXR1cm4gQU1BOwoKfQoKcHVibGljIGNsYXNzIENvbmZpZ0tWIDogVGFibGVFbnRpdHkgewogICAgcHVibGljIHN0cmluZyBWYWx1ZSB7IGdldDsgc2V0OyB9Cn0K",
            "constants_csx": "c3RhdGljIHN0cmluZyBQYXJ0aXRpb25LZXkgPSAiQ2hlZkFNQSI7CgovLyBEZWZpbmUgY2hlZiBzZXJ2ZXIga2V5cwpzdGF0aWMgc3RyaW5nIENoZWZTZXJ2ZXJGUUROS2V5ID0gImNoZWZzZXJ2ZXJfZnFkbiI7CnN0YXRpYyBzdHJpbmcgVXNlcktleSA9ICJ1c2VyIjsKc3RhdGljIHN0cmluZyBVc2VyS2V5S2V5ID0gInVzZXJfa2V5IjsKc3RhdGljIHN0cmluZyBVc2VyUGFzc3dvcmRLZXkgPSAidXNlcl9wYXNzd29yZCI7CnN0YXRpYyBzdHJpbmcgT3JnS2V5ID0gIm9yZyI7CnN0YXRpYyBzdHJpbmcgT3JnS2V5S2V5ID0gIm9yZ192YWxpZGF0b3Jfa2V5IjsKCi8vIERlZmluZSBhdXRvbWF0ZSBzZXJ2ZXIga2V5cwpzdGF0aWMgc3RyaW5nIEF1dG9tYXRlU2VydmVyRlFETktleSA9ICJhdXRvbWF0ZV9mcWRuIjsKCi8vIERlZmluZSB0aGUgbW9uaXRvcmluZyB1c2VyIGtleXMKc3RhdGljIHN0cmluZyBNb25pdG9yVXNlclBhc3N3b3JkS2V5ID0gIm1vbml0b3JfdXNlcl9wYXNzd29yZCI7CnN0YXRpYyBzdHJpbmcgTW9uaXRvcktleUtleSA9ICJtb25pdG9yX2tleSI7CnN0YXRpYyBzdHJpbmcgTW9uaXRvclVzZXJLZXkgPSAibW9uaXRvcl91c2VyIjsK",
            "knife_rb": "Y3VycmVudF9kaXIgPSA6OkZpbGUuZGlybmFtZShfX0ZJTEVfXykKbG9nX2xldmVsICAgICAgICAgICAgICAgIDppbmZvCmxvZ19sb2NhdGlvbiAgICAgICAgICAgICAkc3Rkb3V0Cm5vZGVfbmFtZSAgICAgICAgICAgICAgICAie3sgTk9ERV9OQU1FIH19IgpjbGllbnRfa2V5ICAgICAgICAgICAgICAgOjpGaWxlLmpvaW4oY3VycmVudF9kaXIsICJ7eyBDTElFTlRfS0VZX0ZJTEVOQU1FIH19IikKdmFsaWRhdGlvbl9jbGllbnRfbmFtZSAgICJ7eyBPUkdfVkFMSURBVE9SX05BTUUgfX0iCnZhbGlkYXRpb25fa2V5ICAgICAgICAgICA6OkZpbGUuam9pbihjdXJyZW50X2RpciwgInt7IE9SR19LRVlfRklMRU5BTUUgfX0iKQpjaGVmX3NlcnZlcl91cmwgICAgICAgICAgInt7IENIRUZfU0VSVkVSX1VSTCB9fSIKY29va2Jvb2tfcGF0aCAgICAgICAgICAgIFs6OkZpbGUuam9pbihjdXJyZW50X2RpciwgIi4uL2Nvb2tib29rcyIpXQo="
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "authLevel": "function",
                            "name": "req",
                            "type": "httpTrigger",
                            "direction": "in",
                            "methods": [
                                "get",
                                "post"
                            ]
                        },
                        {
                            "name": "$return",
                            "type": "http",
                            "direction": "out"
                        },
                        {
                            "type": "table",
                            "name": "settingTable",
                            "tableName": "settings",
                            "take": 50,
                            "connection": "AzureWebJobsStorage",
                            "direction": "in"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "run.csx": "[base64ToString(variables('code').run_csx)]",
                    "constants.csx": "[base64ToString(variables('code').constants_csx)]",
                    "knife.rb": "[base64ToString(variables('code').knife_rb)]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "[parameters('functionName')]"
        },
        "apiKey": {
            "type": "string",
            "value": "[listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key]"
        }
    }
}