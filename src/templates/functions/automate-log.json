{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "AutomateLogListener"
        },
        "logAnalyticsWorkspaceID": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID to use when adding data to Log Analytics"
            }
        },
        "logAnalyticsSharedKey": {
            "type": "securestring",
            "metadata": {
                "description": "Primary key to use for authentication to Log Analytics"
            }
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "AutomateLog_csx": "dXNpbmcgU3lzdGVtLk5ldDsKCnB1YmxpYyBjbGFzcyBBdXRvbWF0ZUxvZyB7CglwdWJsaWMgc3RyaW5nIF9fQ1VSU09SIHsgZ2V0OyBzZXQ7IH0KCXB1YmxpYyBzdHJpbmcgX19SRUFMVElNRV9USU1FU1RBTVAgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfX01PTk9UT05JQ19USU1FU1RBTVAgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfQk9PVF9JRCB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9UUkFOU1BPUlQgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBQUklPUklUWSB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIFNZU0xPR19GQUNJTElUWSB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIFNZU0xPR19JREVOVElGSUVSIHsgZ2V0OyBzZXQ7IH0KCXB1YmxpYyBzdHJpbmcgX1BJRCB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9VSUQgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfR0lEIHsgZ2V0OyBzZXQ7IH0KCXB1YmxpYyBzdHJpbmcgX0NPTU0geyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfRVhFIHsgZ2V0OyBzZXQ7IH0KCXB1YmxpYyBzdHJpbmcgX0NNRExJTkUgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfQ0FQX0VGRkVDVElWRSB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0NHUk9VUCB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX1VOSVQgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfU1lTVEVNRF9TTElDRSB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9TWVNURU1EX0lOVk9DQVRJT05fSUQgeyBnZXQ7IHNldDsgfQoJcHVibGljIHN0cmluZyBfTUFDSElORV9JRCB7IGdldDsgc2V0OyB9CglwdWJsaWMgc3RyaW5nIF9IT1NUTkFNRSB7IGdldDsgc2V0OyB9CiAgICBwcml2YXRlIHN0cmluZyBfTUVTU0FHRV9zOwogICAgcHVibGljIHN0cmluZyBNRVNTQUdFX3MgeyBnZXR7CiAgICAgICAgcmV0dXJuIF9NRVNTQUdFX3M7IAogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgYnl0ZVtdIF9NRVNTQUdFX2I7CglwdWJsaWMgYnl0ZVtdIE1FU1NBR0UgeyBzZXR7CiAgICAgICAgX01FU1NBR0VfYiA9IHZhbHVlOwogICAgICAgIF9NRVNTQUdFX3MgPSBTeXN0ZW0uVGV4dC5FbmNvZGluZy5VVEY4LkdldFN0cmluZyh2YWx1ZSk7CiAgICAgICAgfQogICAgfSAgCn0=",
            "run_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiIKI2xvYWQgIkF1dG9tYXRlTG9nLmNzeCIKI2xvYWQgIkF1dG9tYXRlTWVzc2FnZS5jc3giCiNsb2FkICJBdXRvbWF0ZUxvZ1BhcnNlci5jc3giCiNsb2FkICJMb2dBbmFseXRpY3NXcml0ZXIuY3N4IgojbG9hZCAid29ya3NwYWNlLmNzeCIKdXNpbmcgU3lzdGVtLk5ldDsKdXNpbmcgTmV3dG9uc29mdC5Kc29uOwpwdWJsaWMgc3RhdGljIGFzeW5jIFRhc2s8SHR0cFJlc3BvbnNlTWVzc2FnZT4gUnVuKEh0dHBSZXF1ZXN0TWVzc2FnZSByZXEsIFRyYWNlV3JpdGVyIGxvZykKewogICAgbG9nLkluZm8oIkMjIEhUVFAgdHJpZ2dlciBmdW5jdGlvbiBwcm9jZXNzZWQgYSByZXF1ZXN0LiIpOwoKCS8vIEdldCByZXF1ZXN0IGJvZHkKCXZhciBib2R5ID0gYXdhaXQgcmVxLkNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKTsKICAgIHN0cmluZ1tdIGxvZ3MgPSBib2R5LlNwbGl0KCd9Jyk7CgogICAgTG9nQW5hbHl0aWNzV3JpdGVyIGxhdyA9IG5ldyBMb2dBbmFseXRpY3NXcml0ZXIoY3VzdG9tZXJJZCwgc2hhcmVkS2V5LCBsb2cpOwogICAgQXV0b21hdGVMb2cgZGF0YSA9IG5ldyBBdXRvbWF0ZUxvZygpOwogICAgZm9yZWFjaChzdHJpbmcgaXRlbSBpbiBsb2dzKXsKICAgICAgICBzdHJpbmcgYXBwZW5kZWRJdGVtID0gaXRlbTsKICAgICAgICBpZighYXBwZW5kZWRJdGVtLkVuZHNXaXRoKCJ9IikpewogICAgICAgICAgICBhcHBlbmRlZEl0ZW0gPSBhcHBlbmRlZEl0ZW0gKyAnfSc7CiAgICAgICAgfQogICAgICAgIGxvZy5JbmZvKGl0ZW0pOwogICAgICAgIGlmKGl0ZW0gIT0gc3RyaW5nLkVtcHR5KXsKCSAgICAgICAgZGF0YSA9IEpzb25Db252ZXJ0LkRlc2VyaWFsaXplT2JqZWN0PEF1dG9tYXRlTG9nPihhcHBlbmRlZEl0ZW0gYXMgc3RyaW5nKTsKICAgICAgICAgICAgQXV0b21hdGVNZXNzYWdlIGF1dG9tYXRlTWVzc2FnZSA9IEF1dG9tYXRlTG9nUGFyc2VyLlBhcnNlR2VuZXJpY0xvZ01lc3NhZ2UoZGF0YS5NRVNTQUdFX3MsIGxvZyk7CiAgICAgICAgICAgIGxvZy5JbmZvKGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlKTsKICAgICAgICAgICAgaWYoYXV0b21hdGVNZXNzYWdlLnNvdXJjZVBhY2thZ2UgIT0gIlVua25vd24gRW50cnkiKXsKICAgICAgICAgICAgICAgIHN0cmluZyBsb2dOYW1lID0gYXV0b21hdGVNZXNzYWdlLnNvdXJjZVBhY2thZ2UuUmVwbGFjZSgiLSIsICIiKSArICJsb2ciOwogICAgICAgICAgICAgICAgbGF3LlN1Ym1pdChhdXRvbWF0ZU1lc3NhZ2UsIGxvZ05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoJbG9nLkluZm8oZGF0YS5fSE9TVE5BTUUpOwoKCiAgICByZXR1cm4gZGF0YS5NRVNTQUdFX3MgPT0gbnVsbAogICAgICAgID8gcmVxLkNyZWF0ZVJlc3BvbnNlKEh0dHBTdGF0dXNDb2RlLkJhZFJlcXVlc3QsICJQbGVhc2UgcGFzcyBhIG5hbWUgb24gdGhlIHF1ZXJ5IHN0cmluZyBvciBpbiB0aGUgcmVxdWVzdCBib2R5IikKICAgICAgICA6IHJlcS5DcmVhdGVSZXNwb25zZShIdHRwU3RhdHVzQ29kZS5PSywgIkhlbGxvICIgKyBkYXRhLk1FU1NBR0Vfcyk7Cn0KCg==",
            "AutomateLogParser_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiIKI2xvYWQgIkF1dG9tYXRlTWVzc2FnZS5jc3giCnVzaW5nIFN5c3RlbS5OZXQ7CnVzaW5nIE5ld3RvbnNvZnQuSnNvbjsKdXNpbmcgU3lzdGVtLlRleHQuUmVndWxhckV4cHJlc3Npb25zOwp1c2luZyBTeXN0ZW0uR2xvYmFsaXphdGlvbjsKCnB1YmxpYyBzdGF0aWMgY2xhc3MgQXV0b21hdGVMb2dQYXJzZXJ7CiAgICBwdWJsaWMgc3RhdGljIEF1dG9tYXRlTWVzc2FnZSBQYXJzZUdlbmVyaWNMb2dNZXNzYWdlKHN0cmluZyBsb2dNZXNzYWdlLCBUcmFjZVdyaXRlciBsb2cpewogICAgICAgIGlmKGxvZ01lc3NhZ2UuQ29udGFpbnMoImF1dG9tYXRlLWxvYWQtYmFsYW5jZXIiKSl7CiAgICAgICAgICAgIHJldHVybiBQYXJlc0F1dG9tYXRlTG9hZEJhbGFuY2VyTG9nKGxvZ01lc3NhZ2UsIGxvZyk7CiAgICAgICAgfQogICAgICAgIGVsc2V7CiAgICAgICAgICAgIEF1dG9tYXRlTWVzc2FnZSBhdXRvbWF0ZU1lc3NhZ2UgPSBuZXcgQXV0b21hdGVNZXNzYWdlKCk7CiAgICAgICAgICAgIGF1dG9tYXRlTWVzc2FnZS5zb3VyY2VQYWNrYWdlID0gIlVua25vd24gRW50cnkiOwogICAgICAgICAgICByZXR1cm4gYXV0b21hdGVNZXNzYWdlOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIEF1dG9tYXRlTWVzc2FnZSBQYXJlc0F1dG9tYXRlTG9hZEJhbGFuY2VyTG9nKHN0cmluZyBsb2dNZXNzYWdlLCBUcmFjZVdyaXRlciBsb2cpewogICAgICAgIFJlZ2V4IHJ4ID0gbmV3IFJlZ2V4KEAiKC4qKSBcWyguKilcXSAgIiIoLiopIiIgKFxkKykgIiIoLiopIiIgKFxkKykgIiIoLiopIiIgIiIoLiopIiIgIiIoLiopIiIgIiIoLiopIiIgIiIoLiopIiIgKFxkKykiKTsKICAgICAgICBNYXRjaCBtID0gcnguTWF0Y2gobG9nTWVzc2FnZSk7CgogICAgICAgIEN1bHR1cmVJbmZvIHByb3ZpZGVyID0gQ3VsdHVyZUluZm8uSW52YXJpYW50Q3VsdHVyZTsKCQlzdHJpbmcgZGF0ZUZvcm1hdCA9ICJkZC9NTU0veXl5eTpISDptbTpzcyArZmZmZiI7ICAgICAgIAogICAgICAgIGxvZy5JbmZvKCI9PUQgQSBUIEUgVCBJIE0gRT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iKTsKICAgICAgICBsb2cuSW5mbyhtLkdyb3Vwc1syXS5Ub1N0cmluZygpKTsKICAgICAgICBsb2cuSW5mbygiPT1EIEEgVCBFIFQgSSBNIEU9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Iik7CgogICAgICAgIEF1dG9tYXRlTWVzc2FnZSBhdXRvbWF0ZU1lc3NhZ2UgPSBuZXcgQXV0b21hdGVNZXNzYWdlKCk7CiAgICAgICAgYXV0b21hdGVNZXNzYWdlLnNvdXJjZVBhY2thZ2UgPSAiYXV0b21hdGUtbG9hZC1iYWxhbmNlciI7CiAgICAgICAgYXV0b21hdGVNZXNzYWdlLnRpbWUgPSBEYXRlVGltZS5QYXJzZUV4YWN0KG0uR3JvdXBzWzJdLlRvU3RyaW5nKCksIGRhdGVGb3JtYXQsIEN1bHR1cmVJbmZvLkludmFyaWFudEN1bHR1cmUpOwogICAgICAgIGF1dG9tYXRlTWVzc2FnZS5tZXNzYWdlID0gbS5Hcm91cHNbM10uVG9TdHJpbmcoKTsKICAgICAgICBhdXRvbWF0ZU1lc3NhZ2Uuc3RhdHVzID0gbS5Hcm91cHNbNF0uVG9TdHJpbmcoKTsKICAgICAgICByZXR1cm4gYXV0b21hdGVNZXNzYWdlOwogICAgfQp9Cg==",
            "AutomateMessage_csx": "dXNpbmcgU3lzdGVtLk5ldDsKdXNpbmcgU3lzdGVtLlRleHQuUmVndWxhckV4cHJlc3Npb25zOwoKcHVibGljIGNsYXNzIEF1dG9tYXRlTWVzc2FnZXsKICAgIHB1YmxpYyBzdHJpbmcgc291cmNlUGFja2FnZSB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgc3RyaW5nIGxvZ0xldmVsIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBEYXRlVGltZSB0aW1lIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBzdHJpbmcgbWVzc2FnZSB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgc3RyaW5nIGpvYiB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgc3RyaW5nIGZ1bmN0aW9uIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBzdHJpbmcgc3RhdHVzIHsgZ2V0OyBzZXQ7IH0KCiAgICBwdWJsaWMgc3RyaW5nIEdldExvZ0ZyaWVuZGx5UGFja2FnZU5hbWUoKXsKICAgICAgICBzdHJpbmcgc3RyID0gc291cmNlUGFja2FnZTsKICAgICAgICAKICAgICAgICBSZWdleCByZ3ggPSBuZXcgUmVnZXgoIlteYS16QS1aMC05XSIpOwogICAgICAgIHN0ciA9IHJneC5SZXBsYWNlKHN0ciwgIiIpICsgImxvZyI7CgogICAgICAgIHJldHVybiBzdHI7CiAgICB9Cn0K",
            "LogAnalyticsWriter_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiIKdXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uTmV0Owp1c2luZyBTeXN0ZW0uTmV0Lkh0dHA7CnVzaW5nIFN5c3RlbS5OZXQuSHR0cC5IZWFkZXJzOwp1c2luZyBTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5Owp1c2luZyBTeXN0ZW0uVGV4dDsKdXNpbmcgU3lzdGVtLlRocmVhZGluZy5UYXNrczsKdXNpbmcgTmV3dG9uc29mdC5Kc29uOwoKcHVibGljIGNsYXNzIExvZ0FuYWx5dGljc1dyaXRlciB7CiAgICAgICAgLy8gVXBkYXRlIGN1c3RvbWVySWQgdG8geW91ciBPcGVyYXRpb25zIE1hbmFnZW1lbnQgU3VpdGUgd29ya3NwYWNlIElECiAgICAgICAgc3RyaW5nIEN1c3RvbWVySWQ7CiAgICAgICAgLy8gRm9yIHNoYXJlZEtleSwgdXNlIGVpdGhlciB0aGUgcHJpbWFyeSBvciB0aGUgc2Vjb25kYXJ5IENvbm5lY3RlZCBTb3VyY2VzIGNsaWVudCBhdXRoZW50aWNhdGlvbiBrZXkgICAKICAgICAgICBzdHJpbmcgU2hhcmVkS2V5OwogICAgICAgIFRyYWNlV3JpdGVyIEFGTG9nOwoKICAgIHB1YmxpYyBMb2dBbmFseXRpY3NXcml0ZXIoc3RyaW5nIGN1c3RvbWVySWQsIHN0cmluZyBzaGFyZWRLZXksIFRyYWNlV3JpdGVyIGxvZyl7CiAgICAgICAgQ3VzdG9tZXJJZCA9IGN1c3RvbWVySWQ7CiAgICAgICAgU2hhcmVkS2V5ID0gc2hhcmVkS2V5OwogICAgICAgIEFGTG9nID0gbG9nOwogICAgICAgIEFGTG9nLkluZm8oQ3VzdG9tZXJJZCk7CiAgICB9CgogICAgLy8gQnVpbGQgdGhlIEFQSSBzaWduYXR1cmUKICAgIHByaXZhdGUgc3RyaW5nIEJ1aWxkU2lnbmF0dXJlKHN0cmluZyBtZXNzYWdlLCBzdHJpbmcgc2VjcmV0KQogICAgewogICAgICAgIHZhciBlbmNvZGluZyA9IG5ldyBTeXN0ZW0uVGV4dC5BU0NJSUVuY29kaW5nKCk7CiAgICAgICAgYnl0ZVtdIGtleUJ5dGUgPSBDb252ZXJ0LkZyb21CYXNlNjRTdHJpbmcoc2VjcmV0KTsKICAgICAgICBieXRlW10gbWVzc2FnZUJ5dGVzID0gZW5jb2RpbmcuR2V0Qnl0ZXMobWVzc2FnZSk7CiAgICAgICAgdXNpbmcgKHZhciBobWFjc2hhMjU2ID0gbmV3IEhNQUNTSEEyNTYoa2V5Qnl0ZSkpCiAgICAgICAgewogICAgICAgICAgICBieXRlW10gaGFzaCA9IGhtYWNzaGEyNTYuQ29tcHV0ZUhhc2gobWVzc2FnZUJ5dGVzKTsKICAgICAgICAgICAgQUZMb2cuSW5mbygiaW4gYnVpbGQgZnVuY3Rpb24gNSIpOwogICAgICAgICAgICByZXR1cm4gQ29udmVydC5Ub0Jhc2U2NFN0cmluZyhoYXNoKTsKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSB2b2lkIFBvc3REYXRhKHN0cmluZyBzaWduYXR1cmUsIHN0cmluZyBqc29uLCBzdHJpbmcgbG9nTmFtZSwgc3RyaW5nIGRhdGUsIHN0cmluZyB0aW1lc3RhbXAgPSAiIikKICAgIHsgICAgICAgCiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICBzdHJpbmcgdXJsID0gImh0dHBzOi8vIiArIEN1c3RvbWVySWQgKyAiLm9kcy5vcGluc2lnaHRzLmF6dXJlLmNvbS9hcGkvbG9ncz9hcGktdmVyc2lvbj0yMDE2LTA0LTAxIjsKICAgICAgICAgICAgQUZMb2cuSW5mbyh1cmwpOwogICAgCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ2xpZW50IGNsaWVudCA9IG5ldyBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCgpOwogICAgICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiQWNjZXB0IiwgImFwcGxpY2F0aW9uL2pzb24iKTsKICAgICAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkxvZy1UeXBlIiwgbG9nTmFtZSk7CiAgICAgICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJBdXRob3JpemF0aW9uIiwgc2lnbmF0dXJlKTsKICAgICAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIngtbXMtZGF0ZSIsIGRhdGUpOwogICAgICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgidGltZS1nZW5lcmF0ZWQtZmllbGQiLCB0aW1lc3RhbXApOwogICAgCiAgICAgICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCBodHRwQ29udGVudCA9IG5ldyBTdHJpbmdDb250ZW50KGpzb24sIEVuY29kaW5nLlVURjgpOwogICAgICAgICAgICBodHRwQ29udGVudC5IZWFkZXJzLkNvbnRlbnRUeXBlID0gbmV3IE1lZGlhVHlwZUhlYWRlclZhbHVlKCJhcHBsaWNhdGlvbi9qc29uIik7CiAgICAgICAgICAgIFRhc2s8U3lzdGVtLk5ldC5IdHRwLkh0dHBSZXNwb25zZU1lc3NhZ2U+IHJlc3BvbnNlID0gY2xpZW50LlBvc3RBc3luYyhuZXcgVXJpKHVybCksIGh0dHBDb250ZW50KTsKICAgIAogICAgICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENvbnRlbnQgcmVzcG9uc2VDb250ZW50ID0gcmVzcG9uc2UuUmVzdWx0LkNvbnRlbnQ7CiAgICAgICAgICAgIHN0cmluZyByZXN1bHQgPSByZXNwb25zZUNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKS5SZXN1bHQ7CiAgICAgICAgICAgIEFGTG9nLkluZm8oIlJldHVybiBSZXN1bHQ6ICIgKyByZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4Y2VwKQogICAgICAgIHsKICAgICAgICAgICAgQUZMb2cuRXJyb3IoIkFQSSBQb3N0IEV4Y2VwdGlvbjogIiArIGV4Y2VwLk1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgdm9pZCBTdWJtaXQoQXV0b21hdGVNZXNzYWdlIGF1dG9tYXRlTWVzc2FnZSwgc3RyaW5nIGxvZ05hbWUpewogICAgICAgIHZhciBqc29uID0gSnNvbkNvbnZlcnQuU2VyaWFsaXplT2JqZWN0KGF1dG9tYXRlTWVzc2FnZSk7CgogICAgICAgIHZhciBkYXRlc3RyaW5nID0gRGF0ZVRpbWUuVXRjTm93LlRvU3RyaW5nKCJyIik7CiAgICAgICAgc3RyaW5nIHN0cmluZ1RvSGFzaCA9ICJQT1NUXG4iICsganNvbi5MZW5ndGggKyAiXG5hcHBsaWNhdGlvbi9qc29uXG4iICsgIngtbXMtZGF0ZToiICsgZGF0ZXN0cmluZyArICJcbi9hcGkvbG9ncyI7CiAgICAgICAgc3RyaW5nIGhhc2hlZFN0cmluZyA9IEJ1aWxkU2lnbmF0dXJlKHN0cmluZ1RvSGFzaCwgU2hhcmVkS2V5KTsKICAgICAgICBzdHJpbmcgc2lnbmF0dXJlID0gIlNoYXJlZEtleSAiICsgQ3VzdG9tZXJJZCArICI6IiArIGhhc2hlZFN0cmluZzsKCiAgICAgICAgc3RyaW5nIHRpbWVzdGFtcCA9IGF1dG9tYXRlTWVzc2FnZS50aW1lLlRvU3RyaW5nKCJZWVlZLU1NLUREVGhoOm1tOnNzWiIpOwogICAgICAgIEFGTG9nLkluZm8odGltZXN0YW1wKTsKCiAgICAgICAgQUZMb2cuSW5mbygic3VibWl0aW5nIGxvZyIpOwogICAgICAgIFBvc3REYXRhKHNpZ25hdHVyZSwganNvbiwgbG9nTmFtZSwgZGF0ZXN0cmluZywgdGltZXN0YW1wKTsKICAgIH0KCn0="
        },
        "logAnalytics": {
            "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
            "shared_key": "[parameters('logAnalyticsSharedKey')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "authLevel": "function",
                            "name": "req",
                            "type": "httpTrigger",
                            "direction": "in",
                            "methods": [
                                "get",
                                "post"
                            ]
                        },
                        {
                            "name": "$return",
                            "type": "http",
                            "direction": "out"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "AutomateLog.csx": "[base64ToString(variables('code').AutomateLog_csx)]",
                    "AutomateLogParser.csx": "[base64ToString(variables('code').AutomateLogParser_csx)]",
                    "AutomateMessage.csx": "[base64ToString(variables('code').AutomateMessage_csx)]",
                    "LogAnalyticsWriter.csx": "[base64ToString(variables('code').LogAnalyticsWriter_csx)]",
                    "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string sharedKey = \"', variables('logAnalytics').shared_key, '\";')]",
                    "run.csx": "[base64ToString(variables('code').run_csx)]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "[parameters('functionName')]"
        },
        "apiKey": {
            "type": "string",
            "value": "[listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key]"
        }
    }
}