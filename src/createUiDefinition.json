{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Compute.MultiVm",
    "version": "0.1.2-preview",
    "parameters": {
        "basics": [
            {
                "name": "prefix",
                "type": "Microsoft.Common.TextBox",
                "label": "Resource Prefix",
                "toolTip": "A prefix that should be applied to all resources that are created",
                "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9]{1,5}$",
                    "validationMessage": "This must be a lowercase aplhanumeric string and no more than 5 characters"
                }
            }
        ],
        "steps": [
            {
                "name": "customerNetworkStep",
                "label": "Networking",
                "bladeTitle": "Customer Network",
                "subLabel": {
                    "preValidation": "Provide network resources for connection",
                    "postValidation": "Networking components have been specified"
                },
                "elements": [
                    {
                        "name": "warning",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "If you choose to create a new network here, it will be part of the Managed Application resource group, thus you will not be able to manage it yourself."
                        },
                        "visible": true
                    },
                    {
                        "name": "virtualNetwork",
                        "type": "Microsoft.Network.VirtualNetworkCombo",
                        "label": {
                            "virtualNetwork": "Virtual Network",
                            "subnets": "Subnet"
                        },
                        "constraints": {
                            "minAddressPrefixSize": "/26"
                        },
                        "subnets": {
                            "customer": {
                                "label": "Subnet",
                                "constraints": {
                                    "minAddressPrefixSize": "/28"
                                }
                            }
                        },
                        "visible": true,
                        "toolTip": {
                            "virtualNetwork": "Select the virtual network that contains the subnet on which you wish to place the Automate system",
                            "subnets": "Select the subnet to attach the Automate components to" 
                        }
                    }
                ]
            },

            {
                "name": "chefCredentialsStep",
                "label": "Chef Credentials",
                "bladeTitle": "Credentials",
                "subLabel": {
                    "preValidation": "Provide username, password and other account details for Chef Automate",
                    "postValidation": "Credentials have been specified"
                },
                "elements": [
                    {
                        "name": "username",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Username",
                        "toolTip": "Username for the Chef and Automate servers",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-z0-9]+$",
                            "validationMessage": "Only lower case alphanumeric characters are allowed."
                        },
                        "visible": true
                    },
                    {
                        "name": "password",
                        "type": "Microsoft.Common.PasswordBox",
                        "label": {
                            "password": "Password",
                            "confirmPassword": "Confirm password"
                        },
                        "toolTip": "Password to be associated with the above user",
                        "constraints": {
                            "required": true
                        },
                        "visible": true
                    },
                    {
                        "name": "fullname",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Fullname",
                        "toolTip": "Fullname of the account. This should consist of two words",
                        "constraints": {
                            "required": true,
                            "regex": "^\\w+\\s\\w+$",
                            "validationMessage": "Only two words are permitted in as the fullname"
                        },
                        "visible": true
                    },
                    {
                        "name": "emailaddress",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Email Address",
                        "toolTip": "Email address to be associated with this account",
                        "constraints": {
                            "required": true,
                            "regex": "^\\w+([-+.']\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$",
                            "validationMessage": "Please provide a valid email address"
                        },
                        "visible": true
                    },
                    {
                        "name": "orgname",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Organization Name",
                        "toolTip": "Name of the organization to create",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-z0-9]+$",
                            "validationMessage": "The Org name should be in lower case, be one word and only consist of alphanumeric characters"
                        },
                        "visible": true
                    },
                    {
                        "name": "orgdescription",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Organization Description",
                        "toolTip": "A description of the organization, perhaps the epanded version of the name for example",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9 ]+$",
                            "validationMessage": "The org description can only contain upper and lower case characters, numbers and spaces"
                        },
                        "visible": true
                    }
                ]
            },

            {
                "name": "automateLicenceStep",
                "label": "Automate Licence",
                "bladeTitle": "Licence",
                "subLabel": {
                    "preValidation": "Please provide your supplied Automate licence",
                    "postValidation": "Automate licence has been specified"
                },
                "elements": [
                    {
                        "name": "customerName",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Customer Name",
                        "toolTip": "Your name or company name. This should be the same as the name registered for the Automate Licence",
                        "constraints": {
                            "required": true,
                            "regex": "^[a-zA-Z0-9 ]+$",
                            "validationMessage": "A company name or your name must be specified"
                        },
                        "visible": true
                    },
                    {
                        "name": "licence",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Automate Licence",
                        "toolTip": "Please paste your Automate licence file here",
                        "constraints": {
                            "required": true,
                            "regex": "^[A-Za-z0-9-_=]+\\.[A-Za-z0-9-_=]+\\.?[A-Za-z0-9-_.+\/=]*$",
                            "validationMessage": "The Automate licence should be a Json Web Token provided by Chef Software"
                        },
                        "visible": true
                    }
                ]
            },

            {
                "name": "backupStep",
                "label": "Backup",
                "bladeTitle": "Configure Backup",
                "subLabel": {
                    "preValidation": "Please set the time that backups should be run.",
                    "postValidation": "Backup configuration complete"
                },
                "elements": [
                    {
                        "name": "information",
                        "type": "Microsoft.Common.TextBlock",
                        "options": {
                            "text": "Set the time at which backups should occur. Please note that the times are specified in UTC."
                        },
                        "visible": true
                    },
                    {
                        "name": "warning",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Warning",
                            "text": "The Chef Server will be brought down during the backup so please set the backup to run at a time that has minimal impact."
                        },
                        "visible": true
                    },
                    {
                        "name": "hour",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Backup Hour",
                        "defaultValue": "1",
                        "toolTip": "Select the hour at which the backup should run in 24h format.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "0",
                                    "value": 0
                                 },
                                 {
                                    "label": "1",
                                    "value": 1
                                 },
                                 {
                                    "label": "2",
                                    "value": 2
                                 },
                                 {
                                    "label": "3",
                                    "value": 3
                                 },
                                 {
                                    "label": "4",
                                    "value": 4
                                 },
                                 {
                                    "label": "5",
                                    "value": 5
                                 },
                                 {
                                    "label": "6",
                                    "value": 6
                                 },
                                 {
                                    "label": "7",
                                    "value": 7
                                 },
                                 {
                                    "label": "8",
                                    "value": 8
                                 },
                                 {
                                    "label": "9",
                                    "value": 9
                                 },
                                 {
                                    "label": "10",
                                    "value": 10
                                 },
                                 {
                                    "label": "11",
                                    "value": 11
                                 },
                                 {
                                    "label": "12",
                                    "value": 12
                                 },
                                 {
                                    "label": "13",
                                    "value": 13
                                 },
                                 {
                                    "label": "14",
                                    "value": 14
                                 },
                                 {
                                    "label": "15",
                                    "value": 15
                                 },
                                 {
                                    "label": "16",
                                    "value": 16
                                 },
                                 {
                                    "label": "17",
                                    "value": 17
                                 },
                                 {
                                    "label": "18",
                                    "value": 18
                                 },
                                 {
                                    "label": "19",
                                    "value": 19
                                 },
                                 {
                                    "label": "20",
                                    "value": 20
                                 },
                                 {
                                    "label": "21",
                                    "value": 21
                                 },
                                 {
                                    "label": "22",
                                    "value": 22
                                 },
                                 {
                                    "label": "23",
                                    "value": 23
                                 }
                            ],
                            "required": true
                        },
                        "visible": true
                    },

                    {
                        "name": "minute",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Backup Minute",
                        "defaultValue": "0",
                        "toolTip": "Select the minute at which the backup should run.",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "0",
                                    "value": 0
                                 },
                                 {
                                    "label": "5",
                                    "value": 5
                                 },
                                 {
                                    "label": "10",
                                    "value": 10
                                 },
                                 {
                                    "label": "15",
                                    "value": 15
                                 },
                                 {
                                    "label": "20",
                                    "value": 20
                                 },
                                 {
                                    "label": "25",
                                    "value": 25
                                 },
                                 {
                                    "label": "30",
                                    "value": 30
                                 },
                                 {
                                    "label": "35",
                                    "value": 35
                                 },
                                 {
                                    "label": "40",
                                    "value": 40
                                 },
                                 {
                                    "label": "45",
                                    "value": 45
                                 },
                                 {
                                    "label": "50",
                                    "value": 50
                                 },
                                 {
                                    "label": "55",
                                    "value": 55
                                 }
                            ],
                            "required": true
                        },
                        "visible": true
                    }
                ]
            },

            {
                "name": "logAnalyticsStep",
                "label": "Log Analytics",
                "bladeTitle": "Log Analytics Tier",
                "subLabel": {
                    "preValidation": "Please select the tier you want to use for your Log Analytics workspace",
                    "postValidation": "Log Analytics tier has been specified"
                },
                "elements": [
                    {
                        "name": "warning",
                        "type": "Microsoft.Common.InfoBox",
                        "options": {
                            "icon": "Info",
                            "text": "If you are on a Pay As You Go Azure Subscription you cannot use the Free Log Analytics tier."
                        },
                        "visible": true
                    },
                    {
                        "name": "tier",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Tier",
                        "toolTip": "Please select the appropriate service tier",
                        "defaultValue": "Free",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Free",
                                    "value": "Free"
                                },
                                {
                                    "label": "PerNode",
                                    "value": "PerNode"
                                },
                                {
                                    "label": "PerGB2018",
                                    "value": "PerGB2018"
                                }
                            ]
                        },
                        "visible": true
                    },
                    {
                        "name": "location",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Location",
                        "toolTip": "Location that the Log Analytcis should be deployed into",
                        "defaultValue": "eastus",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Australia Central",
                                    "value": "australiacentral"
                                },
                                {
                                    "label": "Australia Central 2",
                                    "value": "australiacentral2"
                                },
                                {
                                    "label": "Australia South East",
                                    "value": "australiasoutheast"
                                },
                                {
                                    "label": "Canada Central",
                                    "value": "canadacentral"
                                },
                                {
                                    "label": "Central India",
                                    "value": "centralindia"
                                },
                                {
                                    "label": "East US",
                                    "value": "eastus"
                                },
                                {
                                    "label": "Japan East",
                                    "value": "japaneast"
                                },
                                {
                                    "label": "South East Asia",
                                    "value": "southeastasia"
                                },
                                {
                                    "label": "UK South",
                                    "value": "uksouth"
                                },
                                {
                                    "label": "West Central US",
                                    "value": "westcentralus"
                                },
                                {
                                    "label": "West Europe",
                                    "value": "westeurope"
                                }                                
                            ],
                            "required": true 
                        },
                        "visible": true
                    }
                ]
            }
        ],
        "outputs": {
            "prefix": "[basics('prefix')]",
            "virtualNetworkName": "[steps('customerNetworkStep').virtualNetwork.name]",
            "customerResourceGroupName": "[steps('customerNetworkStep').virtualNetwork.resourceGroup]",
            "existingVNetFromUI": "[steps('customerNetworkStep').virtualNetwork.newOrExisting]",
            "subnetName": "[steps('customerNetworkStep').virtualNetwork.subnets.customer.name]",
            "chefUsername": "[steps('chefCredentialsStep').username]",
            "chefUserFullname": "[steps('chefCredentialsStep').fullname]",
            "chefUserEmailaddress": "[steps('chefCredentialsStep').emailaddress]",
            "chefUserPassword": "[steps('chefCredentialsStep').password]",
            "chefOrg": "[steps('chefCredentialsStep').orgname]",
            "chefOrgDescription": "[steps('chefCredentialsStep').orgdescription]",
            "automateLicence": "[steps('automateLicenceStep').licence]",
            "customerName": "[steps('automateLicenceStep').customerName]",
            "logAnalyticsTier": "[steps('logAnalyticsStep').tier]",
            "logAnalyticsLocation": "[steps('logAnalyticsStep').location]",
            "backupHour": "[steps('backupStep').hour]",
            "backupMinute": "[steps('backupStep').minute]",
            "location": "[location()]"
        }
    }
}
