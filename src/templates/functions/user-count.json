{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "siteName": {
            "type": "string",
            "metadata": {
                "description": "Name of the site into which the function should be deployed"
            }
        },
        "functionName": {
            "type": "string",
            "metadata": {
                "description": "name of the function"
            },
            "defaultValue": "UserCount"
        },
        "logAnalyticsWorkspaceID": {
            "type": "string",
            "metadata": {
                "description": "The workspace ID to use when adding data to Log Analytics"
            }
        },
        "logAnalyticsSharedKey": {
            "type": "securestring",
            "metadata": {
                "description": "Primary key to use for authentication to Log Analytics"
            }
        },
        "logAnalyticsEnabled": {
            "type": "bool"
        }
    },
    "variables": {
        "name": {
            "site": "[parameters('siteName')]",
            "function": "[parameters('functionName')]"
        },
        "apiVersions": {
            "functions": "2016-08-01"
        },
        "code": {
            "run_csx": "I3IgIk5ld3RvbnNvZnQuSnNvbiINCiNyICJNaWNyb3NvZnQuV2luZG93c0F6dXJlLlN0b3JhZ2UiDQojbG9hZCAid29ya3NwYWNlLmNzeCINCiNsb2FkICJjb25zdGFudHMuY3N4Ig0KDQp1c2luZyBTeXN0ZW07DQp1c2luZyBTeXN0ZW0uTmV0Ow0KdXNpbmcgU3lzdGVtLk5ldC5IdHRwOw0KdXNpbmcgU3lzdGVtLk5ldC5IdHRwLkhlYWRlcnM7DQp1c2luZyBTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5Ow0KdXNpbmcgU3lzdGVtLlRleHQ7DQp1c2luZyBTeXN0ZW0uVGhyZWFkaW5nLlRhc2tzOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uOw0KdXNpbmcgTmV3dG9uc29mdC5Kc29uLkxpbnE7DQp1c2luZyBNaWNyb3NvZnQuV2luZG93c0F6dXJlLlN0b3JhZ2UuVGFibGU7DQogDQovLyBDbGFzcyBmb3Igd2hhdCBzaG91bGQgYmUgc2VudCB0byBMb2cgQW5hbHl0aWNzDQpwdWJsaWMgY2xhc3MgVXNlckNvdW50DQp7DQogICAgcHVibGljIHN0cmluZyBTZXJ2ZXJBZGRyZXNzIHsgZ2V0OyBzZXQ7IH0NCiAgICBwdWJsaWMgaW50IFRvdGFsIHsgZ2V0OyBzZXQ7IH0gDQp9DQogDQpwdWJsaWMgc3RhdGljIHZvaWQgUnVuKFRpbWVySW5mbyBteVRpbWVyLCBDbG91ZFRhYmxlIHNldHRpbmdUYWJsZSwgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIGxvZy5JbmZvKCJTdGFydCBmdW5jdGlvbiB0byBhZGQgaW5mb3JtYXRpb24gdG8gTG9nIEFuYWx5dGljcyIpOw0KIA0KICAgIC8vIExvZ05hbWUgaXMgbmFtZSBvZiB0aGUgZXZlbnQgdHlwZSB0aGF0IGlzIGJlaW5nIHN1Ym1pdHRlZCB0byBMb2cgQW5hbHl0aWNzDQogICAgc3RyaW5nIExvZ05hbWUgPSAiQ2hlZkF1dG9tYXRlQU1BVXNlckNvdW50IjsNCg0KICAgIC8vIEdldCB0aGUgYXV0b21hdGUgdG9rZW4gZnJvbSB0aGUgY29uZmlnIHN0b3JlIHRhYmxlDQogICAgLy8gYW5kIHRoZSBhdXRvbWF0ZSBGUURODQogICAgVGFibGVPcGVyYXRpb24gdG9rZW5fb3BlcmF0aW9uID0gVGFibGVPcGVyYXRpb24uUmV0cmlldmU8Q29uZmlnS1Y+KFBhcnRpdGlvbktleSwgQXV0b21hdGVUb2tlbktleU5hbWUpOw0KICAgIFRhYmxlUmVzdWx0IHRva2VuX3Jlc3VsdCA9IHNldHRpbmdUYWJsZS5FeGVjdXRlKHRva2VuX29wZXJhdGlvbik7DQoNCiAgICBUYWJsZU9wZXJhdGlvbiBmcWRuX29wZXJhdGlvbiA9IFRhYmxlT3BlcmF0aW9uLlJldHJpZXZlPENvbmZpZ0tWPihQYXJ0aXRpb25LZXksIEF1dG9tYXRlRlFETktleU5hbWUpOw0KICAgIFRhYmxlUmVzdWx0IGZxZG5fcmVzdWx0ID0gc2V0dGluZ1RhYmxlLkV4ZWN1dGUoZnFkbl9vcGVyYXRpb24pOw0KDQogICAgLy8gaWYgdGhlcmUgaXMgYSByZXN1bHQgZ2V0IHRoZSBrZXkgdmFsdWUsIG90aGVyd2lzZSBsb2cgZXJyb3INCiAgICBpZiAodG9rZW5fcmVzdWx0LlJlc3VsdCAhPSBudWxsICYmIGZxZG5fcmVzdWx0LlJlc3VsdCAhPSBudWxsKSB7DQoNCiAgICAgICAgLy8gZ2V0IHRoZSB0b2tlbiB2YWx1ZQ0KICAgICAgICBDb25maWdLViB0b2tlbl9zZXR0aW5nID0gKENvbmZpZ0tWKXRva2VuX3Jlc3VsdC5SZXN1bHQ7DQogICAgICAgIENvbmZpZ0tWIGZxZG5fc2V0dGluZyA9IChDb25maWdLVilmcWRuX3Jlc3VsdC5SZXN1bHQ7DQogICAgICAgIHN0cmluZyBhdXRvbWF0ZV90b2tlbiA9IHRva2VuX3NldHRpbmcuVmFsdWU7DQogICAgICAgIHN0cmluZyBhdXRvbWF0ZV9mcWRuID0gZnFkbl9zZXR0aW5nLlZhbHVlOw0KDQogICAgICAgIC8vIENyZWF0ZXMgdGhlIEpTT04gb2JqZWN0LCB3aXRoIGtleS92YWx1ZSBwYWlycw0KICAgICAgICBVc2VyQ291bnQganNvbk9iaiA9IG5ldyBVc2VyQ291bnQoKTsNCiAgICAgICAganNvbk9iaiA9IEdldERhdGEoYXV0b21hdGVfZnFkbiwgYXV0b21hdGVfdG9rZW4sIGxvZyk7DQogICAgICAgIC8vIENvbnZlcnQgdmFyIHRvIGpzb24NCiAgICAgICAgdmFyIGpzb24gPSBKc29uQ29udmVydC5TZXJpYWxpemVPYmplY3QoanNvbk9iaik7DQogICAgDQogICAgICAgIGxvZy5JbmZvKCJqc29uIGZpbGUgc2VudCB0byBMb2cgQW5hbHl0aWNzOiAiICsganNvbik7DQogICAgICAgIA0KICAgICAgICAvLyBDcmVhdGUgYSBoYXNoIGZvciB0aGUgQVBJIHNpZ25hdHVyZQ0KICAgICAgICB2YXIgZGF0ZXN0cmluZyA9IERhdGVUaW1lLlV0Y05vdy5Ub1N0cmluZygiciIpOw0KICAgICAgICBzdHJpbmcgc3RyaW5nVG9IYXNoID0gIlBPU1RcbiIgKyBqc29uLkxlbmd0aCArICJcbmFwcGxpY2F0aW9uL2pzb25cbiIgKyAieC1tcy1kYXRlOiIgKyBkYXRlc3RyaW5nICsgIlxuL2FwaS9sb2dzIjsNCiAgICAgICAgc3RyaW5nIGhhc2hlZFN0cmluZyA9IEJ1aWxkU2lnbmF0dXJlKHN0cmluZ1RvSGFzaCwgc2hhcmVkS2V5KTsNCiAgICAgICAgc3RyaW5nIHNpZ25hdHVyZSA9ICJTaGFyZWRLZXkgIiArIGN1c3RvbWVySWQgKyAiOiIgKyBoYXNoZWRTdHJpbmc7DQogICAgDQogICAgICAgIFBvc3REYXRhKHNpZ25hdHVyZSwgZGF0ZXN0cmluZywganNvbiwgY3VzdG9tZXJJZCwgTG9nTmFtZSwgbG9nKTsNCiAgICB9IGVsc2Ugew0KICAgICAgICBsb2cuSW5mbyhTdHJpbmcuRm9ybWF0KCJVbmFibGUgdG8gZmluZCBzZWxlY3RlZCB0b2tlbiBpbiB0YWJsZTogezB9IiwgQXV0b21hdGVUb2tlbktleU5hbWUpKTsNCiAgICB9DQp9DQogDQovLyBCdWlsZCB0aGUgQVBJIHNpZ25hdHVyZQ0KcHVibGljIHN0YXRpYyBzdHJpbmcgQnVpbGRTaWduYXR1cmUoc3RyaW5nIG1lc3NhZ2UsIHN0cmluZyBzZWNyZXQpDQp7DQogICAgdmFyIGVuY29kaW5nID0gbmV3IFN5c3RlbS5UZXh0LkFTQ0lJRW5jb2RpbmcoKTsNCiAgICBieXRlW10ga2V5Qnl0ZSA9IENvbnZlcnQuRnJvbUJhc2U2NFN0cmluZyhzZWNyZXQpOw0KICAgIGJ5dGVbXSBtZXNzYWdlQnl0ZXMgPSBlbmNvZGluZy5HZXRCeXRlcyhtZXNzYWdlKTsNCiAgICB1c2luZyAodmFyIGhtYWNzaGEyNTYgPSBuZXcgSE1BQ1NIQTI1NihrZXlCeXRlKSkNCiAgICB7DQogICAgICAgIGJ5dGVbXSBoYXNoID0gaG1hY3NoYTI1Ni5Db21wdXRlSGFzaChtZXNzYWdlQnl0ZXMpOw0KICAgICAgICByZXR1cm4gQ29udmVydC5Ub0Jhc2U2NFN0cmluZyhoYXNoKTsNCiAgICB9DQp9DQogDQovLyBTZW5kIGEgcmVxdWVzdCB0byB0aGUgUE9TVCBBUEkgZW5kcG9pbnQNCnB1YmxpYyBzdGF0aWMgdm9pZCBQb3N0RGF0YShzdHJpbmcgc2lnbmF0dXJlLCBzdHJpbmcgZGF0ZSwgc3RyaW5nIGpzb24sIHN0cmluZyBjdXN0b21lcklkLCBzdHJpbmcgTG9nTmFtZSwgVHJhY2VXcml0ZXIgbG9nKQ0Kew0KICAgIC8vIFlvdSBjYW4gdXNlIGFuIG9wdGlvbmFsIGZpZWxkIHRvIHNwZWNpZnkgdGhlIHRpbWVzdGFtcCBmcm9tIHRoZSBkYXRhLiBJZiB0aGUgdGltZSBmaWVsZCBpcyBub3Qgc3BlY2lmaWVkLCBMb2cgQW5hbHl0aWNzIGFzc3VtZXMgdGhlIHRpbWUgaXMgdGhlIG1lc3NhZ2UgaW5nZXN0aW9uIHRpbWUNCiAgICBzdHJpbmcgVGltZVN0YW1wRmllbGQgPSAiIjsNCiAgICB0cnkNCiAgICB7DQogICAgICAgIHN0cmluZyB1cmwgPSAiaHR0cHM6Ly8iICsgY3VzdG9tZXJJZCArICIub2RzLm9waW5zaWdodHMuYXp1cmUuY29tL2FwaS9sb2dzP2FwaS12ZXJzaW9uPTIwMTYtMDQtMDEiOw0KIA0KICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCBjbGllbnQgPSBuZXcgU3lzdGVtLk5ldC5IdHRwLkh0dHBDbGllbnQoKTsNCiAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7DQogICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJMb2ctVHlwZSIsIExvZ05hbWUpOw0KICAgICAgICBjbGllbnQuRGVmYXVsdFJlcXVlc3RIZWFkZXJzLkFkZCgiQXV0aG9yaXphdGlvbiIsIHNpZ25hdHVyZSk7DQogICAgICAgIGNsaWVudC5EZWZhdWx0UmVxdWVzdEhlYWRlcnMuQWRkKCJ4LW1zLWRhdGUiLCBkYXRlKTsNCiAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoInRpbWUtZ2VuZXJhdGVkLWZpZWxkIiwgVGltZVN0YW1wRmllbGQpOw0KIA0KICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENvbnRlbnQgaHR0cENvbnRlbnQgPSBuZXcgU3RyaW5nQ29udGVudChqc29uLCBFbmNvZGluZy5VVEY4KTsNCiAgICAgICAgaHR0cENvbnRlbnQuSGVhZGVycy5Db250ZW50VHlwZSA9IG5ldyBNZWRpYVR5cGVIZWFkZXJWYWx1ZSgiYXBwbGljYXRpb24vanNvbiIpOw0KICAgICAgICBUYXNrPFN5c3RlbS5OZXQuSHR0cC5IdHRwUmVzcG9uc2VNZXNzYWdlPiByZXNwb25zZSA9IGNsaWVudC5Qb3N0QXN5bmMobmV3IFVyaSh1cmwpLCBodHRwQ29udGVudCk7DQogDQogICAgICAgIFN5c3RlbS5OZXQuSHR0cC5IdHRwQ29udGVudCByZXNwb25zZUNvbnRlbnQgPSByZXNwb25zZS5SZXN1bHQuQ29udGVudDsNCiAgICAgICAgc3RyaW5nIHJlc3VsdCA9IHJlc3BvbnNlQ29udGVudC5SZWFkQXNTdHJpbmdBc3luYygpLlJlc3VsdDsNCiAgICAgICAgbG9nLkluZm8oIlJldHVybiBSZXN1bHQ6ICIgKyByZXN1bHQpOw0KICAgIH0NCiAgICBjYXRjaCAoRXhjZXB0aW9uIGV4Y2VwKQ0KICAgIHsNCiAgICAgICAgbG9nLkluZm8oIkFQSSBQb3N0IEV4Y2VwdGlvbjogIiArIGV4Y2VwLk1lc3NhZ2UpOw0KICAgIH0NCn0NCg0KLy8gU2VuZCBhIHJlcXVlc3QgdG8gdGhlIFBPU1QgQVBJIGVuZHBvaW50DQpwdWJsaWMgc3RhdGljIFVzZXJDb3VudCBHZXREYXRhKHN0cmluZyBhdXRvbWF0ZV9mcWRuLCBzdHJpbmcgdG9rZW4sIFRyYWNlV3JpdGVyIGxvZykNCnsNCiAgICANCiAgICBVc2VyQ291bnQgdXNlcnMgPSBuZXcgVXNlckNvdW50KCk7DQogICAgdHJ5DQogICAgew0KICAgICAgICBTZXJ2aWNlUG9pbnRNYW5hZ2VyLlNlcnZlckNlcnRpZmljYXRlVmFsaWRhdGlvbkNhbGxiYWNrICs9IChzZW5kZXIsIGNlcnQsIGNoYWluLCBzc2xQb2xpY3lFcnJvcnMpID0+IHRydWU7DQogICAgICAgIHN0cmluZyB1cmwgPSBTdHJpbmcuRm9ybWF0KCJodHRwczovL3swfS9hcGkvdjAvYXV0aC91c2VycyIsIGF1dG9tYXRlX2ZxZG4pOw0KICAgICAgICBTeXN0ZW0uTmV0Lkh0dHAuSHR0cENsaWVudCBjbGllbnQgPSBuZXcgU3lzdGVtLk5ldC5IdHRwLkh0dHBDbGllbnQoKTsNCiAgICAgICAgY2xpZW50LkRlZmF1bHRSZXF1ZXN0SGVhZGVycy5BZGQoIngtZGF0YS1jb2xsZWN0b3ItdG9rZW4iLCB0b2tlbik7DQoNCiAgICAgICAgIFRhc2s8SHR0cFJlc3BvbnNlTWVzc2FnZT4gcmVzcG9uc2UgPSBjbGllbnQuR2V0QXN5bmMobmV3IFVyaSh1cmwpKTsNCg0KICAgICAgICBpZiAocmVzcG9uc2UuUmVzdWx0LklzU3VjY2Vzc1N0YXR1c0NvZGUpDQogICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgbG9nLkluZm8ocmVzcG9uc2UuUmVzdWx0LkNvbnRlbnQuUmVhZEFzU3RyaW5nQXN5bmMoKS5SZXN1bHQuVG9TdHJpbmcoKSk7DQogICAgICAgICAgICAgICAgdmFyIHVzZXJKc29uID0gcmVzcG9uc2UuUmVzdWx0LkNvbnRlbnQuUmVhZEFzQXN5bmM8ZHluYW1pYz4oKS5SZXN1bHQ7DQogICAgICAgICAgICAgICAgbG9nLkluZm8odXNlckpzb24udXNlcnNbMF0uVG9TdHJpbmcoKSk7DQogICAgICAgICAgICAgICAgSkFycmF5IHVzZXJBcnJheSA9IChKQXJyYXkpdXNlckpzb24udXNlcnM7DQogICAgICAgICAgICAgICAgdXNlcnMuU2VydmVyQWRkcmVzcyA9IGF1dG9tYXRlX2ZxZG47DQogICAgICAgICAgICAgICAgdXNlcnMuVG90YWwgPSB1c2VyQXJyYXkuQ291bnQ7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgbG9nLkluZm8oIlJldHVybiBSZXN1bHQ6ICIgKyByZXNwb25zZS5SZXN1bHQuQ29udGVudCk7DQogICAgfQ0KICAgIGNhdGNoIChFeGNlcHRpb24gZXhjZXApDQogICAgew0KICAgICAgICBsb2cuSW5mbygiQVBJIFBvc3QgRXhjZXB0aW9uOiAiICsgZXhjZXAuTWVzc2FnZSk7DQogICAgfSANCiAgICByZXR1cm4gdXNlcnM7DQp9DQoNCnB1YmxpYyBjbGFzcyBDb25maWdLViA6IFRhYmxlRW50aXR5IHsNCiAgICBwdWJsaWMgc3RyaW5nIFZhbHVlIHsgZ2V0OyBzZXQ7IH0NCn0=",
            "constants_csx": "c3RhdGljIHN0cmluZyBQYXJ0aXRpb25LZXkgPSAiQ2hlZkFNQSI7DQpzdGF0aWMgc3RyaW5nIEF1dG9tYXRlVG9rZW5LZXlOYW1lID0gImF1dG9tYXRlX3Rva2VuIjsNCnN0YXRpYyBzdHJpbmcgQXV0b21hdGVGUUROS2V5TmFtZSA9ICJhdXRvbWF0ZV9mcWRuIjs="
        },
        "logAnalytics": {
            "workspace_id": "[parameters('logAnalyticsWorkspaceId')]",
            "shared_key": "[parameters('logAnalyticsSharedKey')]",
            "enabled": "[parameters('logAnalyticsEnabled')]"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Web/sites/functions",
            "name": "[concat(variables('name').site, '/', variables('name').function)]",
            "condition": "[variables('logAnalytics').enabled]",
            "apiVersion": "[variables('apiVersions').functions]",
            "properties": {
                "config": {
                    "bindings": [
                        {
                            "name": "myTimer",
                            "type": "timerTrigger",
                            "direction": "in",
                            "schedule": "0 */5 * * * *"
                        },
                        {
                            "type": "table",
                            "name": "settingTable",
                            "tableName": "settings",
                            "take": 50,
                            "connection": "AzureWebJobsDashboard",
                            "direction": "in"
                        }
                    ],
                    "disabled": false
                },
                "files": {
                    "run.csx": "[base64ToString(variables('code').run_csx)]",
                    "constants.csx": "[base64ToString(variables('code').constants_csx)]",
                    "workspace.csx": "[concat('static string customerId = \"', variables('logAnalytics').workspace_id, '\";\nstatic string sharedKey = \"', variables('logAnalytics').shared_key, '\";')]"
                }
            }
        }
    ],
    "outputs": {
        "name": {
            "type": "string",
            "value": "if(variables('logAnalytics').enabled, [parameters('functionName'), '')]"
        },        
        "apiKey": {
            "type": "string",
            "value": "[if(variables('logAnalytics').enabled, listsecrets(resourceId('Microsoft.Web/sites/functions', variables('name').site, variables('name').function), '2016-08-01').key, '')]"
        }
    }
}